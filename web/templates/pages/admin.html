{{define "admin"}}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">
        <i class="bi bi-gear-fill text-dark"></i>
        관리자 설정
    </h1>
    <div>
        <button class="btn btn-primary" onclick="saveSettings()">
            <i class="bi bi-save"></i>
            설정 저장
        </button>
    </div>
</div>

<!-- 시스템 상태 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-primary">
            <div class="card-body text-center">
                <h4 class="text-primary" id="dbStatus">정상</h4>
                <small class="text-muted">데이터베이스</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-success">
            <div class="card-body text-center">
                <h4 class="text-success" id="scannerStatus">정상</h4>
                <small class="text-muted">스캐너</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-info">
            <div class="card-body text-center">
                <h4 class="text-info" id="notifierStatus">정상</h4>
                <small class="text-muted">알림</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-warning">
            <div class="card-body text-center">
                <h4 class="text-warning" id="uptime">0일</h4>
                <small class="text-muted">가동시간</small>
            </div>
        </div>
    </div>
</div>

<!-- 설정 탭 -->
<ul class="nav nav-tabs" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
            <i class="bi bi-gear"></i>
            일반 설정
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="scanner-tab" data-bs-toggle="tab" data-bs-target="#scanner" type="button" role="tab">
            <i class="bi bi-search"></i>
            스캐너 설정
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="notification-tab" data-bs-toggle="tab" data-bs-target="#notification" type="button" role="tab">
            <i class="bi bi-bell"></i>
            알림 설정
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab">
            <i class="bi bi-shield-lock"></i>
            보안 설정
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="maintenance-tab" data-bs-toggle="tab" data-bs-target="#maintenance" type="button" role="tab">
            <i class="bi bi-tools"></i>
            유지보수
        </button>
    </li>
</ul>

<div class="tab-content" id="adminTabContent">
    <!-- 일반 설정 -->
    <div class="tab-pane fade show active" id="general" role="tabpanel">
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">일반 설정</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="appName" class="form-label">애플리케이션 이름</label>
                            <input type="text" class="form-control" id="appName" value="OSS Compliance Scanner">
                        </div>
                        <div class="mb-3">
                            <label for="appVersion" class="form-label">버전</label>
                            <input type="text" class="form-control" id="appVersion" value="1.0.0" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="logLevel" class="form-label">로그 레벨</label>
                            <select class="form-select" id="logLevel">
                                <option value="debug">Debug</option>
                                <option value="info" selected>Info</option>
                                <option value="warn">Warning</option>
                                <option value="error">Error</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="timezone" class="form-label">시간대</label>
                            <select class="form-select" id="timezone">
                                <option value="Asia/Seoul" selected>Asia/Seoul (UTC+9)</option>
                                <option value="UTC">UTC</option>
                                <option value="America/New_York">America/New_York</option>
                                <option value="Europe/London">Europe/London</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="language" class="form-label">언어</label>
                            <select class="form-select" id="language">
                                <option value="ko" selected>한국어</option>
                                <option value="en">English</option>
                                <option value="ja">日本語</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="autoUpdate" checked>
                                <label class="form-check-label" for="autoUpdate">
                                    자동 업데이트
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 스캐너 설정 -->
    <div class="tab-pane fade" id="scanner" role="tabpanel">
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">스캐너 설정</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Syft 설정</h6>
                        <div class="mb-3">
                            <label for="syftTimeout" class="form-label">타임아웃 (초)</label>
                            <input type="number" class="form-control" id="syftTimeout" value="300" min="60" max="3600">
                        </div>
                        <div class="mb-3">
                            <label for="syftOutputFormat" class="form-label">출력 형식</label>
                            <select class="form-select" id="syftOutputFormat">
                                <option value="json" selected>JSON</option>
                                <option value="cyclonedx">CycloneDX</option>
                                <option value="spdx">SPDX</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="syftIncludeDevDeps" checked>
                                <label class="form-check-label" for="syftIncludeDevDeps">
                                    개발 의존성 포함
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Grype 설정</h6>
                        <div class="mb-3">
                            <label for="grypeTimeout" class="form-label">타임아웃 (초)</label>
                            <input type="number" class="form-control" id="grypeTimeout" value="600" min="120" max="3600">
                        </div>
                        <div class="mb-3">
                            <label for="grypeFailOn" class="form-label">실패 기준</label>
                            <select class="form-select" id="grypeFailOn">
                                <option value="critical">Critical</option>
                                <option value="high" selected>High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="grypeUpdateDB" checked>
                                <label class="form-check-label" for="grypeUpdateDB">
                                    취약점 DB 자동 업데이트
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 알림 설정 -->
    <div class="tab-pane fade" id="notification" role="tabpanel">
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">알림 설정</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Slack 설정</h6>
                        <div class="mb-3">
                            <label for="slackWebhook" class="form-label">Webhook URL</label>
                            <input type="url" class="form-control" id="slackWebhook" placeholder="https://hooks.slack.com/services/...">
                        </div>
                        <div class="mb-3">
                            <label for="slackChannel" class="form-label">채널</label>
                            <input type="text" class="form-control" id="slackChannel" placeholder="#security-alerts">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="slackEnabled">
                                <label class="form-check-label" for="slackEnabled">
                                    Slack 알림 활성화
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>이메일 설정</h6>
                        <div class="mb-3">
                            <label for="emailSmtp" class="form-label">SMTP 서버</label>
                            <input type="text" class="form-control" id="emailSmtp" placeholder="smtp.gmail.com">
                        </div>
                        <div class="mb-3">
                            <label for="emailPort" class="form-label">포트</label>
                            <input type="number" class="form-control" id="emailPort" value="587">
                        </div>
                        <div class="mb-3">
                            <label for="emailRecipients" class="form-label">수신자</label>
                            <input type="text" class="form-control" id="emailRecipients" placeholder="admin@company.com,security@company.com">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="emailEnabled">
                                <label class="form-check-label" for="emailEnabled">
                                    이메일 알림 활성화
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <h6>알림 조건</h6>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notifyCritical" checked>
                                <label class="form-check-label" for="notifyCritical">
                                    Critical 취약점 발견 시
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notifyHigh" checked>
                                <label class="form-check-label" for="notifyHigh">
                                    High 취약점 발견 시
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notifyLicenseViolation" checked>
                                <label class="form-check-label" for="notifyLicenseViolation">
                                    라이선스 위반 시
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notifyScanFailure">
                                <label class="form-check-label" for="notifyScanFailure">
                                    스캔 실패 시
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 보안 설정 -->
    <div class="tab-pane fade" id="security" role="tabpanel">
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">보안 설정</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>인증 설정</h6>
                        <div class="mb-3">
                            <label for="sessionTimeout" class="form-label">세션 타임아웃 (분)</label>
                            <input type="number" class="form-control" id="sessionTimeout" value="30" min="5" max="480">
                        </div>
                        <div class="mb-3">
                            <label for="maxLoginAttempts" class="form-label">최대 로그인 시도</label>
                            <input type="number" class="form-control" id="maxLoginAttempts" value="5" min="3" max="10">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="requireMFA">
                                <label class="form-check-label" for="requireMFA">
                                    MFA 필수
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>API 보안</h6>
                        <div class="mb-3">
                            <label for="apiRateLimit" class="form-label">API 요청 제한 (분당)</label>
                            <input type="number" class="form-control" id="apiRateLimit" value="100" min="10" max="1000">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enableCORS" checked>
                                <label class="form-check-label" for="enableCORS">
                                    CORS 활성화
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enableAuditLog" checked>
                                <label class="form-check-label" for="enableAuditLog">
                                    감사 로그 활성화
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 유지보수 -->
    <div class="tab-pane fade" id="maintenance" role="tabpanel">
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">유지보수</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>데이터베이스</h6>
                        <div class="mb-3">
                            <button class="btn btn-outline-primary" onclick="backupDatabase()">
                                <i class="bi bi-download"></i>
                                데이터베이스 백업
                            </button>
                        </div>
                        <div class="mb-3">
                            <button class="btn btn-outline-warning" onclick="cleanupOldData()">
                                <i class="bi bi-trash"></i>
                                오래된 데이터 정리
                            </button>
                        </div>
                        <div class="mb-3">
                            <button class="btn btn-outline-info" onclick="optimizeDatabase()">
                                <i class="bi bi-speedometer2"></i>
                                데이터베이스 최적화
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>시스템</h6>
                        <div class="mb-3">
                            <button class="btn btn-outline-secondary" onclick="clearCache()">
                                <i class="bi bi-arrow-clockwise"></i>
                                캐시 정리
                            </button>
                        </div>
                        <div class="mb-3">
                            <button class="btn btn-outline-success" onclick="updateVulnerabilityDB()">
                                <i class="bi bi-database-up"></i>
                                취약점 DB 업데이트
                            </button>
                        </div>
                        <div class="mb-3">
                            <button class="btn btn-outline-danger" onclick="restartService()">
                                <i class="bi bi-arrow-repeat"></i>
                                서비스 재시작
                            </button>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <h6>로그 관리</h6>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="logRetentionDays" class="form-label">로그 보관 기간 (일)</label>
                            <input type="number" class="form-control" id="logRetentionDays" value="30" min="7" max="365">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <button class="btn btn-outline-info" onclick="downloadLogs()">
                                <i class="bi bi-download"></i>
                                로그 다운로드
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 페이지 로드 시 시스템 상태 확인
document.addEventListener('DOMContentLoaded', function() {
    checkSystemStatus();
    loadSettings();
});

// 시스템 상태 확인
async function checkSystemStatus() {
    try {
        // 데이터베이스 상태 확인
        const dbResponse = await fetch('/api/v1/health/db');
        const dbStatus = dbResponse.ok ? '정상' : '오류';
        document.getElementById('dbStatus').textContent = dbStatus;
        document.getElementById('dbStatus').className = dbResponse.ok ? 'text-success' : 'text-danger';
        
        // 스캐너 상태 확인
        const scannerResponse = await fetch('/api/v1/health/scanner');
        const scannerStatus = scannerResponse.ok ? '정상' : '오류';
        document.getElementById('scannerStatus').textContent = scannerStatus;
        document.getElementById('scannerStatus').className = scannerResponse.ok ? 'text-success' : 'text-danger';
        
        // 알림 상태 확인
        const notifierResponse = await fetch('/api/v1/health/notifier');
        const notifierStatus = notifierResponse.ok ? '정상' : '오류';
        document.getElementById('notifierStatus').textContent = notifierStatus;
        document.getElementById('notifierStatus').className = notifierResponse.ok ? 'text-success' : 'text-danger';
        
        // 가동시간 설정 (예시)
        document.getElementById('uptime').textContent = '1일';
        
    } catch (error) {
        console.error('Error checking system status:', error);
    }
}

// 설정 로드
async function loadSettings() {
    try {
        const response = await fetch('/api/v1/settings');
        if (!response.ok) {
            throw new Error('Failed to load settings');
        }
        
        const settings = await response.json();
        
        // 설정값들을 폼에 적용
        document.getElementById('appName').value = settings.app_name || 'OSS Compliance Scanner';
        document.getElementById('appVersion').value = settings.app_version || '1.0.0';
        document.getElementById('logLevel').value = settings.log_level || 'info';
        document.getElementById('timezone').value = settings.timezone || 'Asia/Seoul';
        document.getElementById('language').value = settings.language || 'ko';
        document.getElementById('autoUpdate').checked = settings.auto_update !== false;
        
        // 스캐너 설정
        document.getElementById('syftTimeout').value = settings.syft_timeout || 300;
        document.getElementById('syftOutputFormat').value = settings.syft_output_format || 'json';
        document.getElementById('syftIncludeDevDeps').checked = settings.syft_include_dev_deps !== false;
        
        document.getElementById('grypeTimeout').value = settings.grype_timeout || 600;
        document.getElementById('grypeFailOn').value = settings.grype_fail_on || 'high';
        document.getElementById('grypeUpdateDB').checked = settings.grype_update_db !== false;
        
        // 알림 설정
        document.getElementById('slackWebhook').value = settings.slack_webhook || '';
        document.getElementById('slackChannel').value = settings.slack_channel || '';
        document.getElementById('slackEnabled').checked = settings.slack_enabled || false;
        
        document.getElementById('emailSmtp').value = settings.email_smtp || '';
        document.getElementById('emailPort').value = settings.email_port || 587;
        document.getElementById('emailRecipients').value = settings.email_recipients || '';
        document.getElementById('emailEnabled').checked = settings.email_enabled || false;
        
        // 알림 조건
        document.getElementById('notifyCritical').checked = settings.notify_critical !== false;
        document.getElementById('notifyHigh').checked = settings.notify_high !== false;
        document.getElementById('notifyLicenseViolation').checked = settings.notify_license_violation !== false;
        document.getElementById('notifyScanFailure').checked = settings.notify_scan_failure || false;
        
        // 보안 설정
        document.getElementById('sessionTimeout').value = settings.session_timeout || 30;
        document.getElementById('maxLoginAttempts').value = settings.max_login_attempts || 5;
        document.getElementById('requireMFA').checked = settings.require_mfa || false;
        
        document.getElementById('apiRateLimit').value = settings.api_rate_limit || 100;
        document.getElementById('enableCORS').checked = settings.enable_cors !== false;
        document.getElementById('enableAuditLog').checked = settings.enable_audit_log !== false;
        
        // 유지보수 설정
        document.getElementById('logRetentionDays').value = settings.log_retention_days || 30;
        
    } catch (error) {
        console.error('Error loading settings:', error);
    }
}

// 설정 저장
async function saveSettings() {
    const settings = {
        app_name: document.getElementById('appName').value,
        log_level: document.getElementById('logLevel').value,
        timezone: document.getElementById('timezone').value,
        language: document.getElementById('language').value,
        auto_update: document.getElementById('autoUpdate').checked,
        
        // 스캐너 설정
        syft_timeout: parseInt(document.getElementById('syftTimeout').value),
        syft_output_format: document.getElementById('syftOutputFormat').value,
        syft_include_dev_deps: document.getElementById('syftIncludeDevDeps').checked,
        
        grype_timeout: parseInt(document.getElementById('grypeTimeout').value),
        grype_fail_on: document.getElementById('grypeFailOn').value,
        grype_update_db: document.getElementById('grypeUpdateDB').checked,
        
        // 알림 설정
        slack_webhook: document.getElementById('slackWebhook').value,
        slack_channel: document.getElementById('slackChannel').value,
        slack_enabled: document.getElementById('slackEnabled').checked,
        
        email_smtp: document.getElementById('emailSmtp').value,
        email_port: parseInt(document.getElementById('emailPort').value),
        email_recipients: document.getElementById('emailRecipients').value,
        email_enabled: document.getElementById('emailEnabled').checked,
        
        // 알림 조건
        notify_critical: document.getElementById('notifyCritical').checked,
        notify_high: document.getElementById('notifyHigh').checked,
        notify_license_violation: document.getElementById('notifyLicenseViolation').checked,
        notify_scan_failure: document.getElementById('notifyScanFailure').checked,
        
        // 보안 설정
        session_timeout: parseInt(document.getElementById('sessionTimeout').value),
        max_login_attempts: parseInt(document.getElementById('maxLoginAttempts').value),
        require_mfa: document.getElementById('requireMFA').checked,
        
        api_rate_limit: parseInt(document.getElementById('apiRateLimit').value),
        enable_cors: document.getElementById('enableCORS').checked,
        enable_audit_log: document.getElementById('enableAuditLog').checked,
        
        // 유지보수 설정
        log_retention_days: parseInt(document.getElementById('logRetentionDays').value)
    };
    
    try {
        const response = await fetch('/api/v1/settings', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(settings)
        });
        
        if (!response.ok) {
            throw new Error('Failed to save settings');
        }
        
        alert('설정이 저장되었습니다.');
        
    } catch (error) {
        console.error('Error saving settings:', error);
        alert('설정 저장에 실패했습니다.');
    }
}

// 유지보수 함수들
async function backupDatabase() {
    try {
        const response = await fetch('/api/v1/maintenance/backup', { method: 'POST' });
        if (response.ok) {
            alert('데이터베이스 백업이 시작되었습니다.');
        } else {
            throw new Error('Backup failed');
        }
    } catch (error) {
        console.error('Error backing up database:', error);
        alert('데이터베이스 백업에 실패했습니다.');
    }
}

async function cleanupOldData() {
    if (!confirm('오래된 데이터를 정리하시겠습니까?')) return;
    
    try {
        const response = await fetch('/api/v1/maintenance/cleanup', { method: 'POST' });
        if (response.ok) {
            alert('오래된 데이터 정리가 완료되었습니다.');
        } else {
            throw new Error('Cleanup failed');
        }
    } catch (error) {
        console.error('Error cleaning up old data:', error);
        alert('데이터 정리에 실패했습니다.');
    }
}

async function optimizeDatabase() {
    try {
        const response = await fetch('/api/v1/maintenance/optimize', { method: 'POST' });
        if (response.ok) {
            alert('데이터베이스 최적화가 완료되었습니다.');
        } else {
            throw new Error('Optimization failed');
        }
    } catch (error) {
        console.error('Error optimizing database:', error);
        alert('데이터베이스 최적화에 실패했습니다.');
    }
}

async function clearCache() {
    try {
        const response = await fetch('/api/v1/maintenance/cache/clear', { method: 'POST' });
        if (response.ok) {
            alert('캐시가 정리되었습니다.');
        } else {
            throw new Error('Cache clear failed');
        }
    } catch (error) {
        console.error('Error clearing cache:', error);
        alert('캐시 정리에 실패했습니다.');
    }
}

async function updateVulnerabilityDB() {
    try {
        const response = await fetch('/api/v1/maintenance/update-vuln-db', { method: 'POST' });
        if (response.ok) {
            alert('취약점 데이터베이스 업데이트가 시작되었습니다.');
        } else {
            throw new Error('Update failed');
        }
    } catch (error) {
        console.error('Error updating vulnerability database:', error);
        alert('취약점 데이터베이스 업데이트에 실패했습니다.');
    }
}

async function restartService() {
    if (!confirm('서비스를 재시작하시겠습니까?')) return;
    
    try {
        const response = await fetch('/api/v1/maintenance/restart', { method: 'POST' });
        if (response.ok) {
            alert('서비스 재시작이 요청되었습니다.');
        } else {
            throw new Error('Restart failed');
        }
    } catch (error) {
        console.error('Error restarting service:', error);
        alert('서비스 재시작에 실패했습니다.');
    }
}

async function downloadLogs() {
    try {
        const response = await fetch('/api/v1/maintenance/logs/download');
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'logs.zip';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } else {
            throw new Error('Download failed');
        }
    } catch (error) {
        console.error('Error downloading logs:', error);
        alert('로그 다운로드에 실패했습니다.');
    }
}
</script>
{{end}} 