{{define "reports"}}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">
        <i class="bi bi-graph-up text-info"></i>
        스캔 보고서
    </h1>
    <div>
        <button class="btn btn-primary" onclick="generateReport()">
            <i class="bi bi-file-earmark-text"></i>
            보고서 생성
        </button>
        <button class="btn btn-success ms-2" onclick="exportReport()">
            <i class="bi bi-download"></i>
            내보내기
        </button>
    </div>
</div>

<!-- 보고서 필터 -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label for="repoFilter" class="form-label">저장소</label>
                <select class="form-select" id="repoFilter" onchange="filterReports()">
                    <option value="">모든 저장소</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="dateFromFilter" class="form-label">시작일</label>
                <input type="date" class="form-control" id="dateFromFilter" onchange="filterReports()">
            </div>
            <div class="col-md-3">
                <label for="dateToFilter" class="form-label">종료일</label>
                <input type="date" class="form-control" id="dateToFilter" onchange="filterReports()">
            </div>
            <div class="col-md-3">
                <label for="statusFilter" class="form-label">상태</label>
                <select class="form-select" id="statusFilter" onchange="filterReports()">
                    <option value="">모든 상태</option>
                    <option value="completed">완료</option>
                    <option value="failed">실패</option>
                    <option value="running">진행 중</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- 보고서 통계 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-primary">
            <div class="card-body text-center">
                <h4 class="text-primary" id="totalReports">0</h4>
                <small class="text-muted">총 보고서</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-success">
            <div class="card-body text-center">
                <h4 class="text-success" id="successReports">0</h4>
                <small class="text-muted">성공</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-danger">
            <div class="card-body text-center">
                <h4 class="text-danger" id="failedReports">0</h4>
                <small class="text-muted">실패</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-info">
            <div class="card-body text-center">
                <h4 class="text-info" id="avgScanTime">0</h4>
                <small class="text-muted">평균 스캔 시간(초)</small>
            </div>
        </div>
    </div>
</div>

<!-- 보고서 목록 -->
<div class="card">
    <div class="card-header">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-list-ul"></i>
            스캔 보고서 목록
        </h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="reportsTable">
                <thead>
                    <tr>
                        <th>저장소</th>
                        <th>모듈</th>
                        <th>상태</th>
                        <th>컴포넌트</th>
                        <th>취약점</th>
                        <th>라이선스 위반</th>
                        <th>스캔 시간</th>
                        <th>완료일</th>
                        <th>액션</th>
                    </tr>
                </thead>
                <tbody id="reportsTableBody">
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            <i class="bi bi-hourglass-split"></i>
                            로딩 중...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 보고서 상세 모달 -->
<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">스캔 보고서 상세</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 내용이 동적으로 채워집니다 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" onclick="downloadReport()">다운로드</button>
            </div>
        </div>
    </div>
</div>

<script>
let reports = [];
let filteredReports = [];

// 페이지 로드 시 보고서 데이터 로드
document.addEventListener('DOMContentLoaded', function() {
    loadReports();
});

// 보고서 데이터 로드
async function loadReports() {
    try {
        const response = await fetch('/api/v1/scan-results');
        if (!response.ok) {
            throw new Error('Failed to fetch reports');
        }
        
        reports = await response.json();
        filteredReports = [...reports];
        
        updateStatistics();
        updateReportsTable();
        updateFilters();
    } catch (error) {
        console.error('Error loading reports:', error);
        document.getElementById('reportsTableBody').innerHTML = 
            '<tr><td colspan="9" class="text-center text-danger">데이터 로드 실패</td></tr>';
    }
}

// 통계 업데이트
function updateStatistics() {
    const totalCount = reports.length;
    const successCount = reports.filter(r => r.status === 'completed').length;
    const failedCount = reports.filter(r => r.status === 'failed').length;
    
    // 평균 스캔 시간 계산
    const completedReports = reports.filter(r => r.status === 'completed');
    let totalTime = 0;
    completedReports.forEach(report => {
        if (report.scan_start_time && report.scan_end_time) {
            const start = new Date(report.scan_start_time);
            const end = new Date(report.scan_end_time);
            totalTime += (end - start) / 1000; // 초 단위
        }
    });
    const avgTime = completedReports.length > 0 ? Math.round(totalTime / completedReports.length) : 0;
    
    document.getElementById('totalReports').textContent = totalCount;
    document.getElementById('successReports').textContent = successCount;
    document.getElementById('failedReports').textContent = failedCount;
    document.getElementById('avgScanTime').textContent = avgTime;
}

// 보고서 테이블 업데이트
function updateReportsTable() {
    const tbody = document.getElementById('reportsTableBody');
    
    if (filteredReports.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">스캔 보고서가 없습니다</td></tr>';
        return;
    }
    
    tbody.innerHTML = filteredReports.map(report => {
        const scanTime = report.scan_start_time && report.scan_end_time ? 
            Math.round((new Date(report.scan_end_time) - new Date(report.scan_start_time)) / 1000) : 0;
        
        return `
            <tr>
                <td>
                    <strong>${report.repo_name || 'Unknown'}</strong>
                </td>
                <td>
                    <span class="badge bg-secondary">${report.module_path || 'root'}</span>
                </td>
                <td>
                    <span class="badge bg-${getStatusColor(report.status)}">
                        ${getStatusText(report.status)}
                    </span>
                </td>
                <td>
                    <span class="badge bg-info">${report.total_components || 0}</span>
                </td>
                <td>
                    <span class="badge bg-${report.vulnerabilities_found > 0 ? 'danger' : 'success'}">
                        ${report.vulnerabilities_found || 0}
                    </span>
                </td>
                <td>
                    <span class="badge bg-${report.license_violations > 0 ? 'warning' : 'success'}">
                        ${report.license_violations || 0}
                    </span>
                </td>
                <td>
                    ${scanTime}초
                </td>
                <td>
                    ${report.scan_end_time ? new Date(report.scan_end_time).toLocaleString() : 'N/A'}
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="showReportDetail(${report.id})">
                        <i class="bi bi-eye"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// 필터 업데이트
function updateFilters() {
    const repos = [...new Set(reports.map(r => r.repo_name).filter(Boolean))];
    const repoFilter = document.getElementById('repoFilter');
    
    repos.forEach(repo => {
        const option = document.createElement('option');
        option.value = repo;
        option.textContent = repo;
        repoFilter.appendChild(option);
    });
}

// 보고서 필터링
function filterReports() {
    const repoFilter = document.getElementById('repoFilter').value;
    const dateFromFilter = document.getElementById('dateFromFilter').value;
    const dateToFilter = document.getElementById('dateToFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    filteredReports = reports.filter(report => {
        // 저장소 필터
        if (repoFilter && report.repo_name !== repoFilter) {
            return false;
        }
        
        // 날짜 필터
        if (dateFromFilter && report.scan_start_time) {
            const reportDate = new Date(report.scan_start_time).toISOString().split('T')[0];
            if (reportDate < dateFromFilter) {
                return false;
            }
        }
        
        if (dateToFilter && report.scan_start_time) {
            const reportDate = new Date(report.scan_start_time).toISOString().split('T')[0];
            if (reportDate > dateToFilter) {
                return false;
            }
        }
        
        // 상태 필터
        if (statusFilter && report.status !== statusFilter) {
            return false;
        }
        
        return true;
    });
    
    updateReportsTable();
}

// 상태 색상 반환
function getStatusColor(status) {
    switch (status) {
        case 'completed':
            return 'success';
        case 'failed':
            return 'danger';
        case 'running':
            return 'warning';
        default:
            return 'secondary';
    }
}

// 상태 텍스트 반환
function getStatusText(status) {
    switch (status) {
        case 'completed':
            return '완료';
        case 'failed':
            return '실패';
        case 'running':
            return '진행 중';
        default:
            return '알 수 없음';
    }
}

// 보고서 상세 정보 표시
async function showReportDetail(reportId) {
    try {
        const response = await fetch(`/api/v1/scan-results/${reportId}`);
        if (!response.ok) {
            throw new Error('Failed to fetch report detail');
        }
        
        const report = await response.json();
        
        document.getElementById('modalTitle').textContent = `스캔 보고서: ${report.repo_name}/${report.module_path}`;
        
        const modalBody = document.getElementById('modalBody');
        const scanTime = report.scan_start_time && report.scan_end_time ? 
            Math.round((new Date(report.scan_end_time) - new Date(report.scan_start_time)) / 1000) : 0;
        
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>기본 정보</h6>
                    <table class="table table-sm">
                        <tr><td><strong>저장소:</strong></td><td>${report.repo_name || 'Unknown'}</td></tr>
                        <tr><td><strong>모듈:</strong></td><td>${report.module_path || 'root'}</td></tr>
                        <tr><td><strong>상태:</strong></td><td><span class="badge bg-${getStatusColor(report.status)}">${getStatusText(report.status)}</span></td></tr>
                        <tr><td><strong>스캔 시작:</strong></td><td>${report.scan_start_time ? new Date(report.scan_start_time).toLocaleString() : 'N/A'}</td></tr>
                        <tr><td><strong>스캔 완료:</strong></td><td>${report.scan_end_time ? new Date(report.scan_end_time).toLocaleString() : 'N/A'}</td></tr>
                        <tr><td><strong>스캔 시간:</strong></td><td>${scanTime}초</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>스캔 결과</h6>
                    <table class="table table-sm">
                        <tr><td><strong>총 컴포넌트:</strong></td><td><span class="badge bg-info">${report.total_components || 0}</span></td></tr>
                        <tr><td><strong>발견된 취약점:</strong></td><td><span class="badge bg-${report.vulnerabilities_found > 0 ? 'danger' : 'success'}">${report.vulnerabilities_found || 0}</span></td></tr>
                        <tr><td><strong>라이선스 위반:</strong></td><td><span class="badge bg-${report.license_violations > 0 ? 'warning' : 'success'}">${report.license_violations || 0}</span></td></tr>
                        <tr><td><strong>전체 위험도:</strong></td><td><span class="badge bg-${getRiskColor(report.overall_risk)}">${report.overall_risk || 'Unknown'}</span></td></tr>
                    </table>
                </div>
            </div>
            
            ${report.vulnerabilities_found > 0 ? `
            <div class="row mt-3">
                <div class="col-12">
                    <h6>취약점 세부사항</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card border-danger">
                                <div class="card-body text-center">
                                    <h5 class="text-danger">${report.critical_vulns || 0}</h5>
                                    <small>Critical</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-warning">
                                <div class="card-body text-center">
                                    <h5 class="text-warning">${report.high_vulns || 0}</h5>
                                    <small>High</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-info">
                                <div class="card-body text-center">
                                    <h5 class="text-info">${report.medium_vulns || 0}</h5>
                                    <small>Medium</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <h5 class="text-success">${report.low_vulns || 0}</h5>
                                    <small>Low</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            ` : ''}
            
            ${report.metadata ? `
            <div class="row mt-3">
                <div class="col-12">
                    <h6>메타데이터</h6>
                    <pre class="bg-light p-3 rounded">${JSON.stringify(report.metadata, null, 2)}</pre>
                </div>
            </div>
            ` : ''}
        `;
        
        // 현재 보고서 ID를 모달에 저장
        document.getElementById('reportModal').setAttribute('data-report-id', reportId);
        
        new bootstrap.Modal(document.getElementById('reportModal')).show();
        
    } catch (error) {
        console.error('Error loading report detail:', error);
        alert('보고서 상세 정보 로드에 실패했습니다.');
    }
}

// 위험도 색상 반환
function getRiskColor(risk) {
    switch (risk?.toLowerCase()) {
        case 'critical':
            return 'danger';
        case 'high':
            return 'warning';
        case 'medium':
            return 'info';
        case 'low':
            return 'success';
        default:
            return 'secondary';
    }
}

// 보고서 생성
function generateReport() {
    // 보고서 생성 기능 구현
    alert('보고서 생성 기능은 추후 구현 예정입니다.');
}

// 보고서 내보내기
function exportReport() {
    // CSV 내보내기 기능 구현
    alert('내보내기 기능은 추후 구현 예정입니다.');
}

// 보고서 다운로드
function downloadReport() {
    const reportId = document.getElementById('reportModal').getAttribute('data-report-id');
    if (!reportId) return;
    
    // PDF 다운로드 기능 구현
    alert('다운로드 기능은 추후 구현 예정입니다.');
}
</script>
{{end}} 