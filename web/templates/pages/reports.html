{{define "reports"}}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">
        <i class="bi bi-graph-up text-info"></i>
        스캔 보고서
    </h1>
    <div>
        <button class="btn btn-primary" onclick="generateReport()">
            <i class="bi bi-file-earmark-text"></i>
            보고서 생성
        </button>
        <button class="btn btn-success ms-2" onclick="exportReport()">
            <i class="bi bi-download"></i>
            내보내기
        </button>
    </div>
</div>

<!-- 보고서 필터 -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label for="repoFilter" class="form-label">저장소</label>
                <select class="form-select" id="repoFilter" onchange="filterReports()">
                    <option value="">모든 저장소</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="dateFromFilter" class="form-label">시작일</label>
                <input type="date" class="form-control" id="dateFromFilter" onchange="filterReports()">
            </div>
            <div class="col-md-3">
                <label for="dateToFilter" class="form-label">종료일</label>
                <input type="date" class="form-control" id="dateToFilter" onchange="filterReports()">
            </div>
            <div class="col-md-3">
                <label for="statusFilter" class="form-label">상태</label>
                <select class="form-select" id="statusFilter" onchange="filterReports()">
                    <option value="">모든 상태</option>
                    <option value="completed">완료</option>
                    <option value="failed">실패</option>
                    <option value="running">진행 중</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- 보고서 통계 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-primary">
            <div class="card-body text-center">
                <h4 class="text-primary" id="totalReports">0</h4>
                <small class="text-muted">총 보고서</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-success">
            <div class="card-body text-center">
                <h4 class="text-success" id="successReports">0</h4>
                <small class="text-muted">성공</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-danger">
            <div class="card-body text-center">
                <h4 class="text-danger" id="failedReports">0</h4>
                <small class="text-muted">실패</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-info">
            <div class="card-body text-center">
                <h4 class="text-info" id="avgScanTime">0</h4>
                <small class="text-muted">평균 스캔 시간(초)</small>
            </div>
        </div>
    </div>
</div>

<!-- 보고서 목록 -->
<div class="card">
    <div class="card-header">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-list-ul"></i>
            스캔 보고서 목록
        </h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="reportsTable">
                <thead>
                    <tr>
                        <th>저장소</th>
                        <th>모듈</th>
                        <th>상태</th>
                        <th>컴포넌트</th>
                        <th>취약점</th>
                        <th>라이선스 위반</th>
                        <th>스캔 시간</th>
                        <th>완료일</th>
                        <th>액션</th>
                    </tr>
                </thead>
                <tbody id="reportsTableBody">
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            <i class="bi bi-hourglass-split"></i>
                            로딩 중...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 보고서 상세 모달 -->
<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">스캔 보고서 상세</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 내용이 동적으로 채워집니다 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" onclick="downloadReport()">다운로드</button>
            </div>
        </div>
    </div>
</div>

<!-- 보고서 생성 모달 -->
<div class="modal fade" id="generateReportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-file-earmark-plus text-primary me-2"></i>
                    새 보고서 생성
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="generateReportForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="reportDateFrom" class="form-label">시작일 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="reportDateFrom" required>
                        </div>
                        <div class="col-md-6">
                            <label for="reportDateTo" class="form-label">종료일 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="reportDateTo" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="reportRepositories" class="form-label">저장소 선택</label>
                        <select class="form-select" id="reportRepositories" multiple>
                            <option value="">모든 저장소 포함</option>
                        </select>
                        <div class="form-text">Ctrl+클릭으로 여러 저장소 선택 가능 (선택하지 않으면 모든 저장소 포함)</div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="reportType" class="form-label">보고서 타입</label>
                            <select class="form-select" id="reportType">
                                <option value="pdf">PDF</option>
                                <option value="csv">CSV</option>
                                <option value="excel">Excel</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="reportFormat" class="form-label">보고서 형식</label>
                            <select class="form-select" id="reportFormat">
                                <option value="summary">요약</option>
                                <option value="detailed">상세</option>
                                <option value="executive">경영진용</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">포함할 내용</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeVulns" checked>
                            <label class="form-check-label" for="includeVulns">
                                취약점 정보
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeLicense" checked>
                            <label class="form-check-label" for="includeLicense">
                                라이선스 정보
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeComponents" checked>
                            <label class="form-check-label" for="includeComponents">
                                컴포넌트 상세 정보
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeCharts">
                            <label class="form-check-label" for="includeCharts">
                                차트 및 그래프
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="severityFilter" class="form-label">취약점 심각도 필터</label>
                        <select class="form-select" id="severityFilter">
                            <option value="">모든 심각도</option>
                            <option value="critical">Critical 이상</option>
                            <option value="high">High 이상</option>
                            <option value="medium">Medium 이상</option>
                            <option value="low">Low 이상</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="submitReportGeneration()">
                    <i class="bi bi-gear"></i>
                    보고서 생성 시작
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let reports = [];
let filteredReports = [];

// 페이지 로드 시 보고서 데이터 로드
document.addEventListener('DOMContentLoaded', function() {
    loadReports();
});

// 보고서 데이터 로드
async function loadReports() {
    try {
        const response = await fetch('/api/v1/reports');
        if (!response.ok) {
            throw new Error('Failed to fetch reports');
        }
        
        reports = await response.json();
        filteredReports = [...reports];
        
        updateStatistics();
        updateReportsTable();
        updateFilters();
        
        // 저장소 목록도 로드
        await loadRepositories();
    } catch (error) {
        console.error('Error loading reports:', error);
        document.getElementById('reportsTableBody').innerHTML = 
            '<tr><td colspan="9" class="text-center text-danger">데이터 로드 실패</td></tr>';
    }
}

// 저장소 목록 로드 (보고서 생성 모달용)
async function loadRepositories() {
    try {
        const response = await fetch('/api/v1/sboms');
        if (!response.ok) {
            throw new Error('Failed to fetch repositories');
        }
        
        const sboms = await response.json();
        const repositories = [...new Set(sboms.map(sbom => sbom.repo_name))];
        
        const select = document.getElementById('reportRepositories');
        // 기존 옵션 제거 (첫 번째 기본 옵션 제외)
        while (select.children.length > 1) {
            select.removeChild(select.lastChild);
        }
        
        repositories.forEach(repo => {
            const option = document.createElement('option');
            option.value = repo;
            option.textContent = repo;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading repositories:', error);
    }
}

// 통계 업데이트
function updateStatistics() {
    const totalCount = reports.length;
    const successCount = reports.filter(r => r.status === 'completed').length;
    const failedCount = reports.filter(r => r.status === 'failed').length;
    
    // 평균 스캔 시간 계산
    const completedReports = reports.filter(r => r.status === 'completed');
    let totalTime = 0;
    completedReports.forEach(report => {
        if (report.scan_start_time && report.scan_end_time) {
            const start = new Date(report.scan_start_time);
            const end = new Date(report.scan_end_time);
            totalTime += (end - start) / 1000; // 초 단위
        }
    });
    const avgTime = completedReports.length > 0 ? Math.round(totalTime / completedReports.length) : 0;
    
    document.getElementById('totalReports').textContent = totalCount;
    document.getElementById('successReports').textContent = successCount;
    document.getElementById('failedReports').textContent = failedCount;
    document.getElementById('avgScanTime').textContent = avgTime;
}

// 보고서 테이블 업데이트
function updateReportsTable() {
    const tbody = document.getElementById('reportsTableBody');
    
    if (filteredReports.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">생성된 보고서가 없습니다</td></tr>';
        return;
    }
    
    tbody.innerHTML = filteredReports.map(report => {
        const createdTime = new Date(report.created_at);
        const completedTime = report.completed_at ? new Date(report.completed_at) : null;
        const duration = completedTime ? Math.round((completedTime - createdTime) / 1000) : 0;
        
        return `
            <tr>
                <td>
                    <strong>${report.title}</strong>
                    <small class="d-block text-muted">${report.type.toUpperCase()} - ${report.format}</small>
                </td>
                <td>
                    <span class="badge bg-secondary">${report.generated_by}</span>
                </td>
                <td>
                    <span class="badge bg-${getReportStatusColor(report.status)}">
                        ${getReportStatusText(report.status)}
                    </span>
                </td>
                <td>
                    <span class="badge bg-info">${formatFileSize(report.file_size)}</span>
                </td>
                <td>
                    <span class="text-muted">-</span>
                </td>
                <td>
                    <span class="text-muted">-</span>
                </td>
                <td>
                    ${duration > 0 ? duration + '초' : '-'}
                </td>
                <td>
                    ${completedTime ? completedTime.toLocaleString() : createdTime.toLocaleString()}
                </td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary" onclick="showReportDetail(${report.id})" title="상세 보기">
                            <i class="bi bi-eye"></i>
                        </button>
                        ${report.status === 'completed' ? `
                        <button class="btn btn-sm btn-outline-success" onclick="downloadGeneratedReport(${report.id})" title="다운로드">
                            <i class="bi bi-download"></i>
                        </button>
                        ` : ''}
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteGeneratedReport(${report.id})" title="삭제">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// 필터 업데이트
function updateFilters() {
    const repos = [...new Set(reports.map(r => r.repo_name).filter(Boolean))];
    const repoFilter = document.getElementById('repoFilter');
    
    repos.forEach(repo => {
        const option = document.createElement('option');
        option.value = repo;
        option.textContent = repo;
        repoFilter.appendChild(option);
    });
}

// 보고서 필터링
function filterReports() {
    const repoFilter = document.getElementById('repoFilter').value;
    const dateFromFilter = document.getElementById('dateFromFilter').value;
    const dateToFilter = document.getElementById('dateToFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    filteredReports = reports.filter(report => {
        // 저장소 필터
        if (repoFilter && report.repo_name !== repoFilter) {
            return false;
        }
        
        // 날짜 필터
        if (dateFromFilter && report.scan_start_time) {
            const reportDate = new Date(report.scan_start_time).toISOString().split('T')[0];
            if (reportDate < dateFromFilter) {
                return false;
            }
        }
        
        if (dateToFilter && report.scan_start_time) {
            const reportDate = new Date(report.scan_start_time).toISOString().split('T')[0];
            if (reportDate > dateToFilter) {
                return false;
            }
        }
        
        // 상태 필터
        if (statusFilter && report.status !== statusFilter) {
            return false;
        }
        
        return true;
    });
    
    updateReportsTable();
}

// 상태 색상 반환
function getStatusColor(status) {
    switch (status) {
        case 'completed':
            return 'success';
        case 'failed':
            return 'danger';
        case 'running':
            return 'warning';
        default:
            return 'secondary';
    }
}

// 상태 텍스트 반환
function getStatusText(status) {
    switch (status) {
        case 'completed':
            return '완료';
        case 'failed':
            return '실패';
        case 'running':
            return '진행 중';
        default:
            return '알 수 없음';
    }
}

// 보고서 상세 정보 표시
async function showReportDetail(reportId) {
    try {
        const response = await fetch(`/api/v1/reports/${reportId}`);
        if (!response.ok) {
            throw new Error('Failed to fetch report detail');
        }
        
        const report = await response.json();
        
        document.getElementById('modalTitle').textContent = `스캔 보고서: ${report.repo_name}/${report.module_path}`;
        
        const modalBody = document.getElementById('modalBody');
        const scanTime = report.scan_start_time && report.scan_end_time ? 
            Math.round((new Date(report.scan_end_time) - new Date(report.scan_start_time)) / 1000) : 0;
        
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>기본 정보</h6>
                    <table class="table table-sm">
                        <tr><td><strong>저장소:</strong></td><td>${report.repo_name || 'Unknown'}</td></tr>
                        <tr><td><strong>모듈:</strong></td><td>${report.module_path || 'root'}</td></tr>
                        <tr><td><strong>상태:</strong></td><td><span class="badge bg-${getStatusColor(report.status)}">${getStatusText(report.status)}</span></td></tr>
                        <tr><td><strong>스캔 시작:</strong></td><td>${report.scan_start_time ? new Date(report.scan_start_time).toLocaleString() : 'N/A'}</td></tr>
                        <tr><td><strong>스캔 완료:</strong></td><td>${report.scan_end_time ? new Date(report.scan_end_time).toLocaleString() : 'N/A'}</td></tr>
                        <tr><td><strong>스캔 시간:</strong></td><td>${scanTime}초</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>스캔 결과</h6>
                    <table class="table table-sm">
                        <tr><td><strong>총 컴포넌트:</strong></td><td><span class="badge bg-info">${report.total_components || 0}</span></td></tr>
                        <tr><td><strong>발견된 취약점:</strong></td><td><span class="badge bg-${report.vulnerabilities_found > 0 ? 'danger' : 'success'}">${report.vulnerabilities_found || 0}</span></td></tr>
                        <tr><td><strong>라이선스 위반:</strong></td><td><span class="badge bg-${report.license_violations > 0 ? 'warning' : 'success'}">${report.license_violations || 0}</span></td></tr>
                        <tr><td><strong>전체 위험도:</strong></td><td><span class="badge bg-${getRiskColor(report.overall_risk)}">${report.overall_risk || 'Unknown'}</span></td></tr>
                    </table>
                </div>
            </div>
            
            ${report.vulnerabilities_found > 0 ? `
            <div class="row mt-3">
                <div class="col-12">
                    <h6>취약점 세부사항</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card border-danger">
                                <div class="card-body text-center">
                                    <h5 class="text-danger">${report.critical_vulns || 0}</h5>
                                    <small>Critical</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-warning">
                                <div class="card-body text-center">
                                    <h5 class="text-warning">${report.high_vulns || 0}</h5>
                                    <small>High</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-info">
                                <div class="card-body text-center">
                                    <h5 class="text-info">${report.medium_vulns || 0}</h5>
                                    <small>Medium</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <h5 class="text-success">${report.low_vulns || 0}</h5>
                                    <small>Low</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            ` : ''}
            
            ${report.metadata ? `
            <div class="row mt-3">
                <div class="col-12">
                    <h6>메타데이터</h6>
                    <pre class="bg-light p-3 rounded">${JSON.stringify(report.metadata, null, 2)}</pre>
                </div>
            </div>
            ` : ''}
        `;
        
        // 현재 보고서 ID를 모달에 저장
        document.getElementById('reportModal').setAttribute('data-report-id', reportId);
        
        new bootstrap.Modal(document.getElementById('reportModal')).show();
        
    } catch (error) {
        console.error('Error loading report detail:', error);
        alert('보고서 상세 정보 로드에 실패했습니다.');
    }
}

// 위험도 색상 반환
function getRiskColor(risk) {
    switch (risk?.toLowerCase()) {
        case 'critical':
            return 'danger';
        case 'high':
            return 'warning';
        case 'medium':
            return 'info';
        case 'low':
            return 'success';
        default:
            return 'secondary';
    }
}

// 보고서 생성
function generateReport() {
    // 기본값 설정
    const today = new Date();
    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
    
    document.getElementById('reportDateFrom').value = lastMonth.toISOString().split('T')[0];
    document.getElementById('reportDateTo').value = today.toISOString().split('T')[0];
    
    const modal = new bootstrap.Modal(document.getElementById('generateReportModal'));
    modal.show();
}

// 보고서 생성 제출
async function submitReportGeneration() {
    const form = document.getElementById('generateReportForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const formData = {
        date_from: document.getElementById('reportDateFrom').value,
        date_to: document.getElementById('reportDateTo').value,
        repositories: Array.from(document.getElementById('reportRepositories').selectedOptions).map(opt => opt.value).filter(v => v),
        report_type: document.getElementById('reportType').value,
        format: document.getElementById('reportFormat').value,
        include_vulns: document.getElementById('includeVulns').checked,
        include_license: document.getElementById('includeLicense').checked,
        include_components: document.getElementById('includeComponents').checked,
        include_charts: document.getElementById('includeCharts').checked,
        severity_filter: document.getElementById('severityFilter').value
    };
    
    try {
        const response = await fetch('/api/v1/reports', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
            throw new Error('Failed to create report');
        }
        
        const result = await response.json();
        
        // 모달 닫기
        const modal = bootstrap.Modal.getInstance(document.getElementById('generateReportModal'));
        modal.hide();
        
        // 성공 메시지 표시
        showToast('보고서 생성이 시작되었습니다. 완료되면 목록에서 확인할 수 있습니다.', 'success');
        
        // 보고서 목록 새로고침
        setTimeout(loadReports, 1000);
        
    } catch (error) {
        console.error('Error creating report:', error);
        showToast('보고서 생성 요청에 실패했습니다.', 'error');
    }
}

// 생성된 보고서 다운로드
async function downloadGeneratedReport(reportId) {
    try {
        const response = await fetch(`/api/v1/reports/${reportId}/download`);
        if (!response.ok) {
            throw new Error('Failed to download report');
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        // 파일 이름 추출
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = 'report.pdf';
        if (contentDisposition) {
            const filenameMatch = contentDisposition.match(/filename=([^;]+)/);
            if (filenameMatch) {
                filename = filenameMatch[1].replace(/"/g, '');
            }
        }
        
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
    } catch (error) {
        console.error('Error downloading report:', error);
        showToast('보고서 다운로드에 실패했습니다.', 'error');
    }
}

// 생성된 보고서 삭제
async function deleteGeneratedReport(reportId) {
    if (!confirm('이 보고서를 삭제하시겠습니까?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/reports/${reportId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('Failed to delete report');
        }
        
        showToast('보고서가 삭제되었습니다.', 'success');
        loadReports();
        
    } catch (error) {
        console.error('Error deleting report:', error);
        showToast('보고서 삭제에 실패했습니다.', 'error');
    }
}

// 보고서 상태 색상
function getReportStatusColor(status) {
    switch (status) {
        case 'completed':
            return 'success';
        case 'failed':
            return 'danger';
        case 'generating':
            return 'warning';
        default:
            return 'secondary';
    }
}

// 보고서 상태 텍스트
function getReportStatusText(status) {
    switch (status) {
        case 'completed':
            return '완료';
        case 'failed':
            return '실패';
        case 'generating':
            return '생성 중';
        default:
            return '알 수 없음';
    }
}

// 파일 크기 포맷팅
function formatFileSize(bytes) {
    if (!bytes || bytes === 0) return '0 B';
    
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// 토스트 메시지 표시
function showToast(message, type = 'info') {
    // Bootstrap 토스트가 있다면 사용, 없으면 alert 사용
    if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
        // 토스트 컨테이너가 있는지 확인
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        const toastHTML = `
            <div class="toast" role="alert">
                <div class="toast-header">
                    <strong class="me-auto text-${type === 'error' ? 'danger' : type}">알림</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHTML);
        const toastElement = toastContainer.lastElementChild;
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
        
        // 토스트가 숨겨진 후 제거
        toastElement.addEventListener('hidden.bs.toast', () => {
            toastElement.remove();
        });
    } else {
        alert(message);
    }
}

// 보고서 내보내기
function exportReport() {
    if (filteredReports.length === 0) {
        alert('내보낼 보고서가 없습니다.');
        return;
    }
    
    // CSV 데이터 생성
    const csvHeaders = ['제목', '유형', '형식', '상태', '파일크기', '생성일', '완료일'];
    const csvData = [csvHeaders];
    
    filteredReports.forEach(report => {
        const row = [
            report.title || 'N/A',
            report.type?.toUpperCase() || 'N/A',
            report.format || 'N/A',
            getReportStatusText(report.status),
            formatFileSize(report.file_size),
            report.created_at ? new Date(report.created_at).toLocaleString() : 'N/A',
            report.completed_at ? new Date(report.completed_at).toLocaleString() : 'N/A'
        ];
        csvData.push(row);
    });
    
    // CSV 문자열 생성
    const csvString = csvData.map(row => 
        row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
    ).join('\n');
    
    // BOM 추가하여 한글 깨짐 방지
    const bom = '\uFEFF';
    const blob = new Blob([bom + csvString], { type: 'text/csv;charset=utf-8;' });
    
    // 파일 다운로드
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `scan_reports_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    showToast('보고서 목록이 CSV 파일로 내보내졌습니다.', 'success');
}

// 보고서 다운로드
function downloadReport() {
    const reportId = document.getElementById('reportModal').getAttribute('data-report-id');
    if (!reportId) return;
    
    // 생성된 보고서 다운로드 함수 호출
    downloadGeneratedReport(parseInt(reportId));
}
</script>
{{end}} 