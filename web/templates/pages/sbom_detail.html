{{define "sbom_detail"}}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">대시보드</a></li>
        <li class="breadcrumb-item"><a href="/sboms">SBOM 목록</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{.SBOM.RepoName}}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>
        <i class="bi bi-file-earmark-text text-primary"></i>
        SBOM 상세정보
    </h3>
    <div class="btn-group" role="group">
        <button class="btn btn-outline-success" onclick="rescanSBOM({{.SBOM.ID}})">
            <i class="bi bi-arrow-clockwise"></i>
            재스캔
        </button>
        <button class="btn btn-outline-primary" onclick="downloadSBOM({{.SBOM.ID}})">
            <i class="bi bi-download"></i>
            SBOM 다운로드
        </button>
        <button class="btn btn-outline-secondary" onclick="showRawSBOM()">
            <i class="bi bi-code"></i>
            원본 보기
        </button>
    </div>
</div>

<!-- SBOM 기본 정보 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i>
                    기본 정보
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th class="text-muted" style="width: 150px;">저장소명:</th>
                                <td><strong>{{.SBOM.RepoName}}</strong></td>
                            </tr>
                            <tr>
                                <th class="text-muted">모듈 경로:</th>
                                <td><code>{{.SBOM.ModulePath}}</code></td>
                            </tr>
                            <tr>
                                <th class="text-muted">스캔 날짜:</th>
                                <td>{{.SBOM.ScanDate.Format "2006-01-02 15:04:05"}}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th class="text-muted" style="width: 150px;">Syft 버전:</th>
                                <td>{{.SBOM.SyftVersion}}</td>
                            </tr>
                            <tr>
                                <th class="text-muted">컴포넌트 수:</th>
                                <td><span class="badge bg-info fs-6">{{.SBOM.ComponentCount}}</span></td>
                            </tr>
                            <tr>
                                <th class="text-muted">최종 업데이트:</th>
                                <td>{{.SBOM.UpdatedAt.Format "2006-01-02 15:04:05"}}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 통계 카드 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0" id="totalComponents">{{.SBOM.ComponentCount}}</h4>
                        <small>총 컴포넌트</small>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-puzzle display-6"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0" id="uniqueLanguages">-</h4>
                        <small>프로그래밍 언어</small>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-code-slash display-6"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark cursor-pointer" onclick="showVulnerabilities()">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0" id="totalVulnerabilities">-</h4>
                        <small>취약점 (클릭하여 보기)</small>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-shield-exclamation display-6"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-secondary text-white cursor-pointer" onclick="showLicenses()">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0" id="uniqueLicenses">-</h4>
                        <small>라이선스 (클릭하여 보기)</small>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-award display-6"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 컴포넌트 목록 -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">
                <i class="bi bi-list-ul"></i>
                컴포넌트 목록
            </h5>
            <div class="d-flex gap-2">
                <div class="input-group" style="width: 300px;">
                    <input type="text" class="form-control" id="componentSearch" placeholder="컴포넌트 검색...">
                    <button class="btn btn-outline-secondary" type="button" onclick="filterComponents()">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
                <select class="form-select" id="languageFilter" style="width: 150px;" onchange="filterComponents()">
                    <option value="">모든 언어</option>
                </select>
                <select class="form-select" id="typeFilter" style="width: 150px;" onchange="filterComponents()">
                    <option value="">모든 타입</option>
                </select>
            </div>
        </div>
        <div class="d-flex justify-content-end">
            <div class="d-flex align-items-center gap-2">
                <label for="componentPageSize" class="form-label mb-0">페이지 크기:</label>
                <select class="form-select form-select-sm" id="componentPageSize" style="width: auto;" onchange="changeComponentPageSize()">
                    <option value="10">10</option>
                    <option value="25" selected>25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="componentsTable">
                <thead class="table-light">
                    <tr>
                        <th>이름</th>
                        <th>버전</th>
                        <th>타입</th>
                        <th>언어</th>
                        <th>라이선스</th>
                        <th>위치</th>
                        <th>취약점</th>
                        <th>액션</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Components}}
                    <tr data-language="{{.Language}}" data-type="{{.Type}}">
                        <td>
                            <strong>{{.Name}}</strong>
                            {{if .PURL}}
                            <br><small class="text-muted">{{.PURL}}</small>
                            {{end}}
                        </td>
                        <td>
                            <code>{{.Version}}</code>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark">{{.Type}}</span>
                        </td>
                        <td>
                            {{if .Language}}
                            <span class="badge bg-secondary">{{.Language}}</span>
                            {{else}}
                            <span class="text-muted">-</span>
                            {{end}}
                        </td>
                        <td>
                            {{range .Licenses}}
                            <span class="badge bg-info me-1">{{.}}</span>
                            {{else}}
                            <span class="text-muted">Unknown</span>
                            {{end}}
                        </td>
                        <td>
                            {{range .Locations}}
                            <small class="text-muted d-block">{{.Path}}</small>
                            {{else}}
                            <span class="text-muted">-</span>
                            {{end}}
                        </td>
                        <td>
                            <span class="badge bg-warning text-dark" id="vuln-count-{{.ID}}">-</span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary" onclick="showComponentDetail({{.ID}})">
                                    <i class="bi bi-eye"></i>
                                    상세
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="showComponentVulnerabilities({{.ID}}, '{{.Name}}')">
                                    <i class="bi bi-bug"></i>
                                    취약점
                                </button>
                            </div>
                        </td>
                    </tr>
                    {{else}}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="bi bi-inbox display-4 d-block mb-3"></i>
                            컴포넌트 정보가 없습니다.
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
        
        <!-- 페이지네이션 -->
        <nav aria-label="컴포넌트 페이지네이션" class="mt-3 p-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <small class="text-muted" id="componentPageInfo">페이지 정보</small>
                </div>
                <ul class="pagination pagination-sm mb-0" id="componentPagination">
                    <!-- 페이지네이션 버튼들이 여기에 생성됩니다 -->
                </ul>
            </div>
        </nav>
    </div>
</div>

<!-- Raw SBOM 모달 -->
<div class="modal fade" id="rawSBOMModal" tabindex="-1" aria-labelledby="rawSBOMModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rawSBOMModalLabel">
                    <i class="bi bi-code"></i>
                    원본 SBOM 데이터
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre><code id="rawSBOMContent" class="language-json">{{.SBOM.RawSBOM}}</code></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" onclick="copyRawSBOM()">
                    <i class="bi bi-clipboard"></i>
                    복사
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 라이선스 목록 모달 -->
<div class="modal fade" id="licensesModal" tabindex="-1" aria-labelledby="licensesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="licensesModalLabel">
                    <i class="bi bi-award"></i>
                    라이선스 목록
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="licensesContent">
                <!-- 라이선스 목록이 여기에 로드됩니다 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- 취약점 목록 모달 -->
<div class="modal fade" id="vulnerabilitiesModal" tabindex="-1" aria-labelledby="vulnerabilitiesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="vulnerabilitiesModalLabel">
                    <i class="bi bi-shield-exclamation"></i>
                    취약점 목록
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="vulnerabilitiesContent">
                <!-- 취약점 목록이 여기에 로드됩니다 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- 컴포넌트 상세 모달 -->
<div class="modal fade" id="componentDetailModal" tabindex="-1" aria-labelledby="componentDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="componentDetailModalLabel">
                    <i class="bi bi-puzzle"></i>
                    컴포넌트 상세정보
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="componentDetailContent">
                <!-- 컴포넌트 상세 정보가 여기에 로드됩니다 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- 컴포넌트 취약점 모달 -->
<div class="modal fade" id="componentVulnerabilitiesModal" tabindex="-1" aria-labelledby="componentVulnerabilitiesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="componentVulnerabilitiesModalLabel">
                    <i class="bi bi-bug"></i>
                    컴포넌트 취약점
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="componentVulnerabilitiesContent">
                <!-- 컴포넌트별 취약점이 여기에 로드됩니다 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<style>
.cursor-pointer {
    cursor: pointer;
}
.cursor-pointer:hover {
    transform: translateY(-2px);
    transition: transform 0.2s ease;
}
</style>

<script>
// 페이지네이션 변수
let allComponents = [];
let filteredComponents = [];
let currentPage = 1;
let pageSize = 25;

// 페이지 로드시 초기화
document.addEventListener('DOMContentLoaded', function() {
    loadComponentStats();
    populateFilters();
    initializeComponentPagination();
});

// 컴포넌트 통계 로드
async function loadComponentStats() {
    try {
        const response = await fetch(`/api/v1/sboms/{{.SBOM.ID}}/components`);
        if (response.ok) {
            const components = await response.json();
            
            // 언어별 통계
            const languages = new Set();
            const licenses = new Set();
            
            components.forEach(component => {
                if (component.language) languages.add(component.language);
                if (component.licenses) {
                    component.licenses.forEach(license => licenses.add(license));
                }
                
                // 각 컴포넌트의 취약점 수 업데이트
                const vulnCountElement = document.getElementById(`vuln-count-${component.id}`);
                if (vulnCountElement) {
                    const vulnCount = component.vulnerability_count || 0;
                    vulnCountElement.textContent = vulnCount;
                    
                    // 취약점 수에 따라 배지 색상 변경
                    vulnCountElement.className = 'badge text-dark';
                    if (vulnCount === 0) {
                        vulnCountElement.classList.add('bg-success');
                    } else if (vulnCount <= 2) {
                        vulnCountElement.classList.add('bg-warning');
                    } else {
                        vulnCountElement.classList.add('bg-danger');
                    }
                }
            });
            
            document.getElementById('uniqueLanguages').textContent = languages.size;
            document.getElementById('uniqueLicenses').textContent = licenses.size;
            
            // 취약점 정보 로드
            loadVulnerabilityStats();
        }
    } catch (error) {
        console.error('Error loading component stats:', error);
    }
}

// 취약점 통계 로드
async function loadVulnerabilityStats() {
    try {
        const response = await fetch(`/api/v1/sboms/{{.SBOM.ID}}/vulnerabilities`);
        if (response.ok) {
            const vulnerabilities = await response.json();
            document.getElementById('totalVulnerabilities').textContent = vulnerabilities.length;
        }
    } catch (error) {
        console.error('Error loading vulnerability stats:', error);
    }
}

// 필터 옵션 채우기
function populateFilters() {
    const table = document.getElementById('componentsTable');
    const languages = new Set();
    const types = new Set();
    
    Array.from(table.querySelectorAll('tbody tr')).forEach(row => {
        const language = row.getAttribute('data-language');
        const type = row.getAttribute('data-type');
        if (language) languages.add(language);
        if (type) types.add(type);
    });
    
    const languageFilter = document.getElementById('languageFilter');
    const typeFilter = document.getElementById('typeFilter');
    
    languages.forEach(lang => {
        const option = document.createElement('option');
        option.value = lang;
        option.textContent = lang;
        languageFilter.appendChild(option);
    });
    
    types.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        typeFilter.appendChild(option);
    });
}

// 컴포넌트 필터링
function filterComponents() {
    const searchTerm = document.getElementById('componentSearch').value.toLowerCase();
    const languageFilter = document.getElementById('languageFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    const table = document.getElementById('componentsTable');
    
    Array.from(table.querySelectorAll('tbody tr')).forEach(row => {
        const name = row.querySelector('td:first-child strong').textContent.toLowerCase();
        const language = row.getAttribute('data-language');
        const type = row.getAttribute('data-type');
        
        const matchesSearch = name.includes(searchTerm);
        const matchesLanguage = !languageFilter || language === languageFilter;
        const matchesType = !typeFilter || type === typeFilter;
        
        row.style.display = (matchesSearch && matchesLanguage && matchesType) ? '' : 'none';
    });
}

// Raw SBOM 보기
function showRawSBOM() {
    const modal = new bootstrap.Modal(document.getElementById('rawSBOMModal'));
    modal.show();
}

// Raw SBOM 복사
function copyRawSBOM() {
    const content = document.getElementById('rawSBOMContent').textContent;
    navigator.clipboard.writeText(content).then(() => {
        alert('클립보드에 복사되었습니다.');
    });
}

// SBOM 다운로드
function downloadSBOM(sbomId) {
    const link = document.createElement('a');
    link.href = `/api/v1/sboms/${sbomId}/download`;
    link.download = `sbom-${sbomId}.json`;
    link.click();
}

// SBOM 재스캔
async function rescanSBOM(sbomId) {
    if (!confirm('이 SBOM을 다시 스캔하시겠습니까?')) {
        return;
    }

    try {
        const response = await fetch(`/api/v1/sboms/${sbomId}/rescan`, {
            method: 'POST'
        });

        if (!response.ok) {
            throw new Error('재스캔 시작에 실패했습니다.');
        }

        const result = await response.json();
        alert('재스캔이 시작되었습니다. 완료되면 페이지가 새로고침됩니다.');
        
        // 페이지 새로고침 (실제로는 진행상황 모니터링 구현 필요)
        setTimeout(() => {
            location.reload();
        }, 5000);
        
    } catch (error) {
        console.error('Rescan error:', error);
        alert('재스캔 시작 중 오류가 발생했습니다: ' + error.message);
    }
}

// 라이선스 목록 보기 (페이지네이션 포함)
let currentLicensePage = 1;
let currentLicensePageSize = 10;

async function showLicenses() {
    await loadLicenses(1, 10); // 첫 페이지, 기본 10개씩
    const modal = new bootstrap.Modal(document.getElementById('licensesModal'));
    modal.show();
}

async function loadLicenses(page = 1, pageSize = 10) {
    try {
        currentLicensePage = page;
        currentLicensePageSize = pageSize;
        
        const response = await fetch(`/api/v1/sboms/{{.SBOM.ID}}/licenses?page=${page}&pageSize=${pageSize}`);
        if (response.ok) {
            const data = await response.json();
            
                         let content = '<div class="d-flex justify-content-between align-items-center mb-3">' +
                 '<div>' +
                     '<span class="text-muted">' +
                         '총 ' + data.total_components + '개 컴포넌트, ' + data.total_groups + '개 라이선스 그룹' +
                     '</span>' +
                 '</div>' +
                 '<div class="d-flex align-items-center gap-2">' +
                     '<label for="licensePageSize" class="form-label mb-0">페이지 크기:</label>' +
                     '<select class="form-select form-select-sm" id="licensePageSize" style="width: auto;" onchange="changeLicensePageSize()">' +
                         '<option value="10"' + (pageSize === 10 ? ' selected' : '') + '>10</option>' +
                         '<option value="20"' + (pageSize === 20 ? ' selected' : '') + '>20</option>' +
                         '<option value="50"' + (pageSize === 50 ? ' selected' : '') + '>50</option>' +
                     '</select>' +
                 '</div>' +
             '</div>';
            
            if (data.license_groups.length > 0) {
                content += `<div class="accordion" id="licensesAccordion">`;
                
                data.license_groups.forEach((group, index) => {
                    const isUnknown = group.license === 'Unknown';
                    const badgeClass = isUnknown ? 'bg-secondary' : 'bg-primary';
                    
                    content += `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading${index}">
                                <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#collapse${index}" 
                                        aria-expanded="${index === 0 ? 'true' : 'false'}" aria-controls="collapse${index}">
                                    <span class="badge ${badgeClass} me-3">${group.license}</span>
                                    <span class="text-muted">${group.count}개 컴포넌트</span>
                                </button>
                            </h2>
                            <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                                 aria-labelledby="heading${index}" data-bs-parent="#licensesAccordion">
                                <div class="accordion-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>컴포넌트</th>
                                                    <th>버전</th>
                                                    <th>타입</th>
                                                    <th>언어</th>
                                                    <th>취약점</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                    `;
                    
                    group.components.forEach(comp => {
                        const vulnCount = comp.vulnerability_count || 0;
                        const vulnBadgeClass = vulnCount === 0 ? 'bg-success' : vulnCount <= 2 ? 'bg-warning' : 'bg-danger';
                        
                        content += `
                            <tr>
                                <td><strong>${comp.name}</strong></td>
                                <td><code>${comp.version}</code></td>
                                <td><span class="badge bg-light text-dark">${comp.type}</span></td>
                                <td>${comp.language ? `<span class="badge bg-secondary">${comp.language}</span>` : '-'}</td>
                                <td><span class="badge ${vulnBadgeClass} text-dark">${vulnCount}</span></td>
                            </tr>
                        `;
                    });
                    
                    content += `
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                content += `</div>`;
                
                // 페이지네이션 추가
                if (data.total_pages > 1) {
                    content += `
                        <nav aria-label="라이선스 페이지네이션" class="mt-3">
                            <ul class="pagination justify-content-center">
                                <li class="page-item ${!data.has_prev ? 'disabled' : ''}">
                                    <a class="page-link" href="#" onclick="loadLicenses(${page - 1}, ${pageSize}); return false;">
                                        <i class="bi bi-chevron-left"></i>
                                    </a>
                                </li>
                    `;
                    
                    // 페이지 번호들
                    const startPage = Math.max(1, page - 2);
                    const endPage = Math.min(data.total_pages, page + 2);
                    
                    if (startPage > 1) {
                        content += `
                            <li class="page-item">
                                <a class="page-link" href="#" onclick="loadLicenses(1, ${pageSize}); return false;">1</a>
                            </li>
                        `;
                        if (startPage > 2) {
                            content += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                        }
                    }
                    
                    for (let i = startPage; i <= endPage; i++) {
                        content += `
                            <li class="page-item ${i === page ? 'active' : ''}">
                                <a class="page-link" href="#" onclick="loadLicenses(${i}, ${pageSize}); return false;">${i}</a>
                            </li>
                        `;
                    }
                    
                    if (endPage < data.total_pages) {
                        if (endPage < data.total_pages - 1) {
                            content += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                        }
                        content += `
                            <li class="page-item">
                                <a class="page-link" href="#" onclick="loadLicenses(${data.total_pages}, ${pageSize}); return false;">${data.total_pages}</a>
                            </li>
                        `;
                    }
                    
                    content += `
                                <li class="page-item ${!data.has_next ? 'disabled' : ''}">
                                    <a class="page-link" href="#" onclick="loadLicenses(${page + 1}, ${pageSize}); return false;">
                                        <i class="bi bi-chevron-right"></i>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    `;
                }
            } else {
                content += `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-award display-4 d-block mb-3"></i>
                        라이선스 정보가 없습니다.
                    </div>
                `;
            }
            
            document.getElementById('licensesContent').innerHTML = content;
        }
    } catch (error) {
        console.error('Error loading licenses:', error);
        alert('라이선스 정보를 불러오는 중 오류가 발생했습니다.');
    }
}

function changeLicensePageSize() {
    const pageSize = parseInt(document.getElementById('licensePageSize').value);
    loadLicenses(1, pageSize); // 페이지 크기 변경 시 첫 페이지로
}

// 전체 취약점 보기
async function showVulnerabilities() {
    try {
        const response = await fetch(`/api/v1/sboms/{{.SBOM.ID}}/vulnerabilities`);
        if (response.ok) {
            const vulnerabilities = await response.json();
            
            let content = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>CVE ID</th>
                                <th>심각도</th>
                                <th>컴포넌트</th>
                                <th>버전</th>
                                <th>CVSS 점수</th>
                                <th>설명</th>
                                <th>발견일</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            if (vulnerabilities.length === 0) {
                content += `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="bi bi-shield-check display-4 d-block mb-3"></i>
                            발견된 취약점이 없습니다.
                        </td>
                    </tr>
                `;
            } else {
                vulnerabilities.forEach(vuln => {
                    const severityClass = getSeverityClass(vuln.severity);
                    content += `
                        <tr>
                            <td><code>${vuln.vuln_id}</code></td>
                            <td><span class="badge ${severityClass}">${vuln.severity}</span></td>
                            <td><strong>${vuln.metadata?.component_name || 'Unknown'}</strong></td>
                            <td><code>${vuln.metadata?.component_version || 'Unknown'}</code></td>
                            <td>${vuln.cvss3_score || vuln.cvss2_score || 'N/A'}</td>
                            <td><small>${vuln.description || 'No description'}</small></td>
                            <td><small>${vuln.created_at ? new Date(vuln.created_at).toLocaleDateString() : 'N/A'}</small></td>
                        </tr>
                    `;
                });
            }
            
            content += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('vulnerabilitiesContent').innerHTML = content;
            const modal = new bootstrap.Modal(document.getElementById('vulnerabilitiesModal'));
            modal.show();
        }
    } catch (error) {
        console.error('Error loading vulnerabilities:', error);
        alert('취약점 정보를 불러오는 중 오류가 발생했습니다.');
    }
}

// 컴포넌트별 취약점 보기
async function showComponentVulnerabilities(componentId, componentName) {
    try {
        // 먼저 해당 컴포넌트의 취약점 조회
        const sbomResponse = await fetch(`/api/v1/sboms/{{.SBOM.ID}}/vulnerabilities`);
        if (sbomResponse.ok) {
            const allVulnerabilities = await sbomResponse.json();
            const componentVulns = allVulnerabilities.filter(vuln => 
                vuln.metadata?.component_name === componentName
            );
            
            document.getElementById('componentVulnerabilitiesModalLabel').innerHTML = `
                <i class="bi bi-bug"></i>
                ${componentName} 취약점 (${componentVulns.length}개)
            `;
            
            let content = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>CVE ID</th>
                                <th>심각도</th>
                                <th>CVSS 점수</th>
                                <th>설명</th>
                                <th>수정 정보</th>
                                <th>발견일</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            if (componentVulns.length === 0) {
                content += `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="bi bi-shield-check display-4 d-block mb-3"></i>
                            이 컴포넌트에서 발견된 취약점이 없습니다.
                        </td>
                    </tr>
                `;
            } else {
                componentVulns.forEach(vuln => {
                    const severityClass = getSeverityClass(vuln.severity);
                    const fixes = vuln.fixes ? vuln.fixes.map(fix => 
                        `<small class="text-success d-block">• ${fix.version || fix.state}</small>`
                    ).join('') : '<span class="text-muted">정보 없음</span>';
                    
                    content += `
                        <tr>
                            <td><code>${vuln.vuln_id}</code></td>
                            <td><span class="badge ${severityClass}">${vuln.severity}</span></td>
                            <td>${vuln.cvss3_score || vuln.cvss2_score || 'N/A'}</td>
                            <td><small>${vuln.description || 'No description'}</small></td>
                            <td>${fixes}</td>
                            <td><small>${vuln.created_at ? new Date(vuln.created_at).toLocaleDateString() : 'N/A'}</small></td>
                        </tr>
                    `;
                });
            }
            
            content += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('componentVulnerabilitiesContent').innerHTML = content;
            const modal = new bootstrap.Modal(document.getElementById('componentVulnerabilitiesModal'));
            modal.show();
        }
    } catch (error) {
        console.error('Error loading component vulnerabilities:', error);
        alert('컴포넌트 취약점 정보를 불러오는 중 오류가 발생했습니다.');
    }
}

// 심각도별 CSS 클래스 반환
function getSeverityClass(severity) {
    switch (severity?.toLowerCase()) {
        case 'critical':
            return 'bg-danger';
        case 'high':
            return 'bg-warning';
        case 'medium':
            return 'bg-info';
        case 'low':
            return 'bg-success';
        default:
            return 'bg-secondary';
    }
}

// 컴포넌트 상세정보 보기
async function showComponentDetail(componentId) {
    try {
        const response = await fetch(`/api/v1/components/${componentId}`);
        if (response.ok) {
            const component = await response.json();
            
            const content = `
                <div class="row">
                    <div class="col-12">
                        <h6>기본 정보</h6>
                        <table class="table table-sm">
                            <tr><th>이름:</th><td>${component.name || 'Unknown'}</td></tr>
                            <tr><th>버전:</th><td>${component.version || 'Unknown'}</td></tr>
                            <tr><th>타입:</th><td>${component.type || 'Unknown'}</td></tr>
                            <tr><th>언어:</th><td>${component.language || 'Unknown'}</td></tr>
                            <tr><th>PURL:</th><td><code>${component.purl || 'N/A'}</code></td></tr>
                            <tr><th>CPE:</th><td><code>${component.cpe || 'N/A'}</code></td></tr>
                        </table>
                        
                        <h6>라이선스</h6>
                        <div class="mb-3">
                            ${component.licenses && component.licenses.length > 0 ? 
                                component.licenses.map(license => 
                                    `<span class="badge bg-info me-1">${license}</span>`
                                ).join('') : 
                                '<span class="text-muted">라이선스 정보 없음</span>'
                            }
                        </div>
                        
                        <h6>위치</h6>
                        <div>
                            ${component.locations && component.locations.length > 0 ? 
                                component.locations.map(location => 
                                    `<small class="text-muted d-block"><i class="bi bi-folder"></i> ${location.path}</small>`
                                ).join('') : 
                                '<span class="text-muted">위치 정보 없음</span>'
                            }
                        </div>
                        
                        <h6>메타데이터</h6>
                        <div>
                            ${component.metadata && Object.keys(component.metadata).length > 0 ? 
                                `<pre class="bg-light p-2 rounded"><code>${JSON.stringify(component.metadata, null, 2)}</code></pre>` : 
                                '<span class="text-muted">메타데이터 없음</span>'
                            }
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('componentDetailContent').innerHTML = content;
            const modal = new bootstrap.Modal(document.getElementById('componentDetailModal'));
            modal.show();
        }
    } catch (error) {
        console.error('Error loading component detail:', error);
        alert('컴포넌트 상세정보를 불러오는 중 오류가 발생했습니다.');
    }
}

// 컴포넌트 페이지네이션 초기화
function initializeComponentPagination() {
    const rows = document.querySelectorAll('#componentsTable tbody tr');
    allComponents = Array.from(rows).map(row => ({
        element: row,
        name: row.cells[0]?.textContent?.trim().toLowerCase() || '',
        language: row.dataset.language || '',
        type: row.dataset.type || ''
    }));
    filteredComponents = [...allComponents];
    applyComponentPagination();
}

// 컴포넌트 필터링
function filterComponents() {
    const search = document.getElementById('componentSearch').value.toLowerCase();
    const languageFilter = document.getElementById('languageFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    
    filteredComponents = allComponents.filter(component => {
        const matchesSearch = component.name.includes(search);
        const matchesLanguage = !languageFilter || component.language === languageFilter;
        const matchesType = !typeFilter || component.type === typeFilter;
        
        return matchesSearch && matchesLanguage && matchesType;
    });
    
    currentPage = 1; // 필터링 후 첫 페이지로 이동
    applyComponentPagination();
}

// 컴포넌트 페이지네이션 적용
function applyComponentPagination() {
    // 모든 행 숨기기
    allComponents.forEach(component => {
        component.element.style.display = 'none';
    });
    
    // 페이지네이션 계산
    const totalItems = filteredComponents.length;
    const totalPages = Math.ceil(totalItems / pageSize);
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, totalItems);
    
    // 현재 페이지가 총 페이지 수를 초과하는 경우 첫 페이지로 이동
    if (currentPage > totalPages && totalPages > 0) {
        currentPage = 1;
        applyComponentPagination();
        return;
    }
    
    // 현재 페이지의 항목들만 표시
    for (let i = startIndex; i < endIndex; i++) {
        if (filteredComponents[i]) {
            filteredComponents[i].element.style.display = '';
        }
    }
    
    // 페이지네이션 UI 업데이트
    updateComponentPagination(totalItems, currentPage, totalPages);
}

// 컴포넌트 페이지네이션 UI 업데이트
function updateComponentPagination(totalItems, currentPageNum, totalPages) {
    const pageInfo = document.getElementById('componentPageInfo');
    const pagination = document.getElementById('componentPagination');
    
    if (totalItems === 0) {
        pageInfo.textContent = '항목이 없습니다';
        pagination.innerHTML = '';
        return;
    }
    
    const startItem = (currentPageNum - 1) * pageSize + 1;
    const endItem = Math.min(currentPageNum * pageSize, totalItems);
    pageInfo.textContent = `${startItem}-${endItem} / ${totalItems}개 항목`;
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // 이전 페이지 버튼
    paginationHTML += `
        <li class="page-item ${currentPageNum === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="goToComponentPage(${currentPageNum - 1}); return false;">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>
    `;
    
    // 페이지 번호들
    const startPage = Math.max(1, currentPageNum - 2);
    const endPage = Math.min(totalPages, currentPageNum + 2);
    
    if (startPage > 1) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="goToComponentPage(1); return false;">1</a>
            </li>
        `;
        if (startPage > 2) {
            paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <li class="page-item ${i === currentPageNum ? 'active' : ''}">
                <a class="page-link" href="#" onclick="goToComponentPage(${i}); return false;">${i}</a>
            </li>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="goToComponentPage(${totalPages}); return false;">${totalPages}</a>
            </li>
        `;
    }
    
    // 다음 페이지 버튼
    paginationHTML += `
        <li class="page-item ${currentPageNum === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="goToComponentPage(${currentPageNum + 1}); return false;">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>
    `;
    
    pagination.innerHTML = paginationHTML;
}

// 컴포넌트 페이지 이동
function goToComponentPage(page) {
    const totalPages = Math.ceil(filteredComponents.length / pageSize);
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    applyComponentPagination();
}

// 컴포넌트 페이지 크기 변경
function changeComponentPageSize() {
    pageSize = parseInt(document.getElementById('componentPageSize').value);
    currentPage = 1;
    applyComponentPagination();
}

// 검색어 입력시 실시간 필터링
document.getElementById('componentSearch').addEventListener('keyup', filterComponents);
</script>
{{end}} 