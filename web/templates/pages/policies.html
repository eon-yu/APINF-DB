{{define "policies"}}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">
        <i class="bi bi-gear text-warning"></i>
        정책 관리
    </h1>
    <div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#licensePolicyModal">
            <i class="bi bi-plus-circle"></i>
            라이선스 정책 추가
        </button>
        <button class="btn btn-success ms-2" data-bs-toggle="modal" data-bs-target="#vulnPolicyModal">
            <i class="bi bi-plus-circle"></i>
            취약점 정책 추가
        </button>
    </div>
</div>

<!-- 정책 통계 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-file-text"></i>
                    라이선스 정책
                </h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="text-primary" id="licensePolicyCount">0</h4>
                        <small class="text-muted">활성 정책</small>
                    </div>
                    <div class="text-end">
                        <div class="badge bg-success" id="licenseBlockCount">0</div>
                        <small class="text-muted d-block">차단 정책</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-shield-exclamation"></i>
                    취약점 정책
                </h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="text-primary" id="vulnPolicyCount">0</h4>
                        <small class="text-muted">활성 정책</small>
                    </div>
                    <div class="text-end">
                        <div class="badge bg-danger" id="vulnFailCount">0</div>
                        <small class="text-muted d-block">실패 정책</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 라이선스 정책 -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-file-text"></i>
            라이선스 정책 목록
        </h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="licensePolicyTable">
                <thead>
                    <tr>
                        <th>라이선스명</th>
                        <th>액션</th>
                        <th>사유</th>
                        <th>상태</th>
                        <th>생성일</th>
                        <th>액션</th>
                    </tr>
                </thead>
                <tbody id="licensePolicyTableBody">
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <i class="bi bi-hourglass-split"></i>
                            로딩 중...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 취약점 정책 -->
<div class="card">
    <div class="card-header">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-shield-exclamation"></i>
            취약점 정책 목록
        </h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="vulnPolicyTable">
                <thead>
                    <tr>
                        <th>최소 심각도</th>
                        <th>최대 CVSS</th>
                        <th>액션</th>
                        <th>유예기간</th>
                        <th>상태</th>
                        <th>생성일</th>
                        <th>액션</th>
                    </tr>
                </thead>
                <tbody id="vulnPolicyTableBody">
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="bi bi-hourglass-split"></i>
                            로딩 중...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 라이선스 정책 모달 -->
<div class="modal fade" id="licensePolicyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">라이선스 정책 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="licensePolicyForm">
                    <!-- 탭 네비게이션 -->
                    <ul class="nav nav-tabs mb-3" id="licenseTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="predefined-tab" data-bs-toggle="tab" data-bs-target="#predefined" type="button" role="tab">
                                <i class="bi bi-list-check"></i>
                                일반 라이선스
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="custom-tab" data-bs-toggle="tab" data-bs-target="#custom" type="button" role="tab">
                                <i class="bi bi-pencil"></i>
                                직접 입력
                            </button>
                        </li>
                    </ul>
                    
                    <!-- 탭 컨텐츠 -->
                    <div class="tab-content" id="licenseTabContent">
                        <!-- 일반 라이선스 탭 -->
                        <div class="tab-pane fade show active" id="predefined" role="tabpanel">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label mb-0">라이선스 선택</label>
                                    <div>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllLicenses()">
                                            <i class="bi bi-check-all"></i> 전체 선택
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary ms-1" onclick="clearAllLicenses()">
                                            <i class="bi bi-x"></i> 전체 해제
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 검색 필터 -->
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="licenseSearch" placeholder="라이선스 검색..." onkeyup="filterLicenses()">
                                </div>
                                
                                <!-- 카테고리별 라이선스 -->
                                <div class="accordion" id="licenseAccordion">
                                    <!-- 허용 라이선스 -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#permitteeLicenses">
                                                <span class="badge bg-success me-2">허용</span>
                                                허용된 라이선스 (Permissive)
                                            </button>
                                        </h2>
                                        <div id="permitteeLicenses" class="accordion-collapse collapse show" data-bs-parent="#licenseAccordion">
                                            <div class="accordion-body">
                                                <div class="row" id="permittedLicenseList">
                                                    <!-- 허용 라이선스 체크박스들 -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 제한적 라이선스 -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#restrictiveLicenses">
                                                <span class="badge bg-warning me-2">경고</span>
                                                제한적 라이선스 (Restrictive)
                                            </button>
                                        </h2>
                                        <div id="restrictiveLicenses" class="accordion-collapse collapse" data-bs-parent="#licenseAccordion">
                                            <div class="accordion-body">
                                                <div class="row" id="restrictiveLicenseList">
                                                    <!-- 제한적 라이선스 체크박스들 -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 코플렙트 라이선스 -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#copyleftLicenses">
                                                <span class="badge bg-danger me-2">차단</span>
                                                코플렙트 라이선스 (Copyleft)
                                            </button>
                                        </h2>
                                        <div id="copyleftLicenses" class="accordion-collapse collapse" data-bs-parent="#licenseAccordion">
                                            <div class="accordion-body">
                                                <div class="row" id="copyleftLicenseList">
                                                    <!-- 코플렙트 라이선스 체크박스들 -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <strong>선택된 라이선스:</strong> <span id="selectedLicenseCount">0</span>개
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 직접 입력 탭 -->
                        <div class="tab-pane fade" id="custom" role="tabpanel">
                            <div class="mb-3">
                                <label for="customLicenseName" class="form-label">라이선스명</label>
                                <input type="text" class="form-control" id="customLicenseName">
                                <div class="form-text">예: Custom-License-1.0, Proprietary-License</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 공통 설정 -->
                    <hr>
                    <div class="mb-3">
                        <label for="licenseAction" class="form-label">액션</label>
                        <select class="form-select" id="licenseAction" required>
                            <option value="allow">허용</option>
                            <option value="warn">경고</option>
                            <option value="block">차단</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="licenseReason" class="form-label">사유</label>
                        <textarea class="form-control" id="licenseReason" rows="3" required placeholder="정책 적용 사유를 입력하세요..."></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="licenseActive" checked>
                            <label class="form-check-label" for="licenseActive">
                                활성화
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="createLicensePolicies()">
                    <span id="createButtonText">정책 생성</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 취약점 정책 모달 -->
<div class="modal fade" id="vulnPolicyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">취약점 정책 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="vulnPolicyForm">
                    <div class="mb-3">
                        <label for="minSeverity" class="form-label">최소 심각도</label>
                        <select class="form-select" id="minSeverity" required>
                            <option value="Critical">Critical</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="maxCVSS" class="form-label">최대 CVSS 점수</label>
                        <input type="number" class="form-control" id="maxCVSS" min="0" max="10" step="0.1" required>
                        <div class="form-text">0.0 (낮음) ~ 10.0 (높음)</div>
                    </div>
                    <div class="mb-3">
                        <label for="vulnAction" class="form-label">액션</label>
                        <select class="form-select" id="vulnAction" required>
                            <option value="fail">실패</option>
                            <option value="warn">경고</option>
                            <option value="allow">허용</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="gracePeriod" class="form-label">유예기간 (일)</label>
                        <input type="number" class="form-control" id="gracePeriod" min="0" value="0">
                        <div class="form-text">0 = 즉시 적용</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="vulnActive" checked>
                            <label class="form-check-label" for="vulnActive">
                                활성화
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="createVulnPolicy()">생성</button>
            </div>
        </div>
    </div>
</div>

<script>
let licensePolicies = [];
let vulnPolicies = [];

// 페이지 로드 시 정책 데이터 로드
document.addEventListener('DOMContentLoaded', function() {
    loadPolicies();
});

// 정책 데이터 로드
async function loadPolicies() {
    await Promise.all([
        loadLicensePolicies(),
        loadVulnPolicies()
    ]);
    updateStatistics();
}

// 라이선스 정책 로드
async function loadLicensePolicies() {
    try {
        const response = await fetch('/api/v1/policies/licenses');
        if (!response.ok) {
            throw new Error('Failed to fetch license policies');
        }
        
        licensePolicies = await response.json();
        updateLicensePolicyTable();
    } catch (error) {
        console.error('Error loading license policies:', error);
        document.getElementById('licensePolicyTableBody').innerHTML = 
            '<tr><td colspan="6" class="text-center text-danger">데이터 로드 실패</td></tr>';
    }
}

// 취약점 정책 로드
async function loadVulnPolicies() {
    try {
        const response = await fetch('/api/v1/policies/vulnerabilities');
        if (!response.ok) {
            throw new Error('Failed to fetch vulnerability policies');
        }
        
        vulnPolicies = await response.json();
        updateVulnPolicyTable();
    } catch (error) {
        console.error('Error loading vulnerability policies:', error);
        document.getElementById('vulnPolicyTableBody').innerHTML = 
            '<tr><td colspan="7" class="text-center text-danger">데이터 로드 실패</td></tr>';
    }
}

// 통계 업데이트
function updateStatistics() {
    const activeLicensePolicies = licensePolicies.filter(p => p.is_active);
    const blockLicensePolicies = activeLicensePolicies.filter(p => p.action === 'block');
    
    const activeVulnPolicies = vulnPolicies.filter(p => p.is_active);
    const failVulnPolicies = activeVulnPolicies.filter(p => p.action === 'fail');
    
    document.getElementById('licensePolicyCount').textContent = activeLicensePolicies.length;
    document.getElementById('licenseBlockCount').textContent = blockLicensePolicies.length;
    document.getElementById('vulnPolicyCount').textContent = activeVulnPolicies.length;
    document.getElementById('vulnFailCount').textContent = failVulnPolicies.length;
}

// 라이선스 정책 테이블 업데이트
function updateLicensePolicyTable() {
    const tbody = document.getElementById('licensePolicyTableBody');
    
    if (licensePolicies.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">라이선스 정책이 없습니다</td></tr>';
        return;
    }
    
    tbody.innerHTML = licensePolicies.map(policy => `
        <tr>
            <td><strong>${policy.license_name}</strong></td>
            <td>
                <span class="badge bg-${getActionColor(policy.action)}">${policy.action}</span>
            </td>
            <td>${policy.reason || '-'}</td>
            <td>
                <span class="badge bg-${policy.is_active ? 'success' : 'secondary'}">
                    ${policy.is_active ? '활성' : '비활성'}
                </span>
            </td>
            <td>${policy.created_at ? new Date(policy.created_at).toLocaleDateString() : '-'}</td>
            <td>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteLicensePolicy(${policy.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

// 취약점 정책 테이블 업데이트
function updateVulnPolicyTable() {
    const tbody = document.getElementById('vulnPolicyTableBody');
    
    if (vulnPolicies.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">취약점 정책이 없습니다</td></tr>';
        return;
    }
    
    tbody.innerHTML = vulnPolicies.map(policy => `
        <tr>
            <td>
                <span class="badge severity-${policy.min_severity_level.toLowerCase()}">${policy.min_severity_level}</span>
            </td>
            <td>${policy.max_cvss_score || 'N/A'}</td>
            <td>
                <span class="badge bg-${getActionColor(policy.action)}">${policy.action}</span>
            </td>
            <td>${policy.grace_period_days || 0}일</td>
            <td>
                <span class="badge bg-${policy.is_active ? 'success' : 'secondary'}">
                    ${policy.is_active ? '활성' : '비활성'}
                </span>
            </td>
            <td>${policy.created_at ? new Date(policy.created_at).toLocaleDateString() : '-'}</td>
            <td>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteVulnPolicy(${policy.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

// 액션 색상 반환
function getActionColor(action) {
    switch (action) {
        case 'block':
        case 'fail':
            return 'danger';
        case 'warn':
            return 'warning';
        case 'allow':
            return 'success';
        default:
            return 'secondary';
    }
}

// 라이선스 데이터 정의
const licenseData = {
    permissive: [
        { name: 'MIT', description: 'MIT License' },
        { name: 'Apache-2.0', description: 'Apache License 2.0' },
        { name: 'BSD-2-Clause', description: 'BSD 2-Clause License' },
        { name: 'BSD-3-Clause', description: 'BSD 3-Clause License' },
        { name: 'ISC', description: 'ISC License' },
        { name: 'Unlicense', description: 'The Unlicense' },
        { name: 'WTFPL', description: 'Do What The F*ck You Want To Public License' },
        { name: 'Zlib', description: 'zlib License' },
        { name: 'X11', description: 'X11 License' },
        { name: 'PostgreSQL', description: 'PostgreSQL License' }
    ],
    restrictive: [
        { name: 'LGPL-2.1', description: 'GNU Lesser General Public License v2.1' },
        { name: 'LGPL-3.0', description: 'GNU Lesser General Public License v3.0' },
        { name: 'MPL-2.0', description: 'Mozilla Public License 2.0' },
        { name: 'EPL-1.0', description: 'Eclipse Public License 1.0' },
        { name: 'EPL-2.0', description: 'Eclipse Public License 2.0' },
        { name: 'CDDL-1.0', description: 'Common Development and Distribution License 1.0' },
        { name: 'CPL-1.0', description: 'Common Public License 1.0' },
        { name: 'IPL-1.0', description: 'IBM Public License 1.0' }
    ],
    copyleft: [
        { name: 'GPL-2.0', description: 'GNU General Public License v2.0' },
        { name: 'GPL-3.0', description: 'GNU General Public License v3.0' },
        { name: 'AGPL-3.0', description: 'GNU Affero General Public License v3.0' },
        { name: 'GPL-2.0-only', description: 'GNU General Public License v2.0 only' },
        { name: 'GPL-3.0-only', description: 'GNU General Public License v3.0 only' },
        { name: 'GPL-2.0-or-later', description: 'GNU General Public License v2.0 or later' },
        { name: 'GPL-3.0-or-later', description: 'GNU General Public License v3.0 or later' },
        { name: 'AGPL-1.0', description: 'Affero General Public License v1.0' },
        { name: 'EUPL-1.2', description: 'European Union Public License 1.2' }
    ]
};

// 모달이 열릴 때 라이선스 체크박스 초기화
document.getElementById('licensePolicyModal').addEventListener('show.bs.modal', function() {
    initializeLicenseCheckboxes();
    updateSelectedLicenseCount();
});

// 라이선스 체크박스 초기화
function initializeLicenseCheckboxes() {
    // 허용 라이선스
    const permittedList = document.getElementById('permittedLicenseList');
    permittedList.innerHTML = licenseData.permissive.map(license => `
        <div class="col-md-6">
            <div class="form-check">
                <input class="form-check-input license-checkbox" type="checkbox" 
                       id="license_${license.name}" value="${license.name}" 
                       onchange="updateSelectedLicenseCount()">
                <label class="form-check-label" for="license_${license.name}">
                    <strong>${license.name}</strong>
                    <br><small class="text-muted">${license.description}</small>
                </label>
            </div>
        </div>
    `).join('');

    // 제한적 라이선스
    const restrictiveList = document.getElementById('restrictiveLicenseList');
    restrictiveList.innerHTML = licenseData.restrictive.map(license => `
        <div class="col-md-6">
            <div class="form-check">
                <input class="form-check-input license-checkbox" type="checkbox" 
                       id="license_${license.name}" value="${license.name}"
                       onchange="updateSelectedLicenseCount()">
                <label class="form-check-label" for="license_${license.name}">
                    <strong>${license.name}</strong>
                    <br><small class="text-muted">${license.description}</small>
                </label>
            </div>
        </div>
    `).join('');

    // 코플렙트 라이선스
    const copyleftList = document.getElementById('copyleftLicenseList');
    copyleftList.innerHTML = licenseData.copyleft.map(license => `
        <div class="col-md-6">
            <div class="form-check">
                <input class="form-check-input license-checkbox" type="checkbox" 
                       id="license_${license.name}" value="${license.name}"
                       onchange="updateSelectedLicenseCount()">
                <label class="form-check-label" for="license_${license.name}">
                    <strong>${license.name}</strong>
                    <br><small class="text-muted">${license.description}</small>
                </label>
            </div>
        </div>
    `).join('');
}

// 전체 선택
function selectAllLicenses() {
    const checkboxes = document.querySelectorAll('.license-checkbox');
    const visibleCheckboxes = Array.from(checkboxes).filter(cb => 
        cb.closest('.col-md-6').style.display !== 'none'
    );
    visibleCheckboxes.forEach(cb => cb.checked = true);
    updateSelectedLicenseCount();
}

// 전체 해제
function clearAllLicenses() {
    const checkboxes = document.querySelectorAll('.license-checkbox');
    checkboxes.forEach(cb => cb.checked = false);
    updateSelectedLicenseCount();
}

// 라이선스 검색 필터
function filterLicenses() {
    const searchTerm = document.getElementById('licenseSearch').value.toLowerCase();
    const checkboxes = document.querySelectorAll('.license-checkbox');
    
    checkboxes.forEach(checkbox => {
        const container = checkbox.closest('.col-md-6');
        const licenseName = checkbox.value.toLowerCase();
        const label = checkbox.nextElementSibling.textContent.toLowerCase();
        
        if (licenseName.includes(searchTerm) || label.includes(searchTerm)) {
            container.style.display = '';
        } else {
            container.style.display = 'none';
        }
    });
}

// 선택된 라이선스 수 업데이트
function updateSelectedLicenseCount() {
    const selectedCount = document.querySelectorAll('.license-checkbox:checked').length;
    document.getElementById('selectedLicenseCount').textContent = selectedCount;
    
    // 버튼 텍스트 업데이트
    const buttonText = selectedCount > 0 ? `${selectedCount}개 정책 생성` : '정책 생성';
    document.getElementById('createButtonText').textContent = buttonText;
}

// 라이선스 정책 생성 (다중)
async function createLicensePolicies() {
    const activeTab = document.querySelector('#licenseTab .nav-link.active').id;
    const action = document.getElementById('licenseAction').value;
    const reason = document.getElementById('licenseReason').value;
    const isActive = document.getElementById('licenseActive').checked;
    
    if (!reason.trim()) {
        alert('사유를 입력해주세요.');
        return;
    }
    
    let licensesToCreate = [];
    
    if (activeTab === 'predefined-tab') {
        // 선택된 라이선스들 수집
        const selectedLicenses = document.querySelectorAll('.license-checkbox:checked');
        if (selectedLicenses.length === 0) {
            alert('최소 하나의 라이선스를 선택해주세요.');
            return;
        }
        licensesToCreate = Array.from(selectedLicenses).map(cb => cb.value);
    } else {
        // 직접 입력
        const customLicense = document.getElementById('customLicenseName').value.trim();
        if (!customLicense) {
            alert('라이선스명을 입력해주세요.');
            return;
        }
        licensesToCreate = [customLicense];
    }
    
    // 중복 확인
    const existingLicenses = licensePolicies.map(p => p.license_name);
    const duplicates = licensesToCreate.filter(license => existingLicenses.includes(license));
    
    if (duplicates.length > 0) {
        if (!confirm(`다음 라이선스는 이미 정책이 존재합니다:\n${duplicates.join(', ')}\n\n계속하시겠습니까?`)) {
            return;
        }
        // 중복 제거
        licensesToCreate = licensesToCreate.filter(license => !duplicates.includes(license));
    }
    
    if (licensesToCreate.length === 0) {
        alert('생성할 정책이 없습니다.');
        return;
    }
    
    // 확인 다이얼로그
    if (!confirm(`${licensesToCreate.length}개의 라이선스 정책을 생성하시겠습니까?\n\n라이선스: ${licensesToCreate.join(', ')}\n액션: ${action}\n상태: ${isActive ? '활성' : '비활성'}`)) {
        return;
    }
    
    try {
        const createButton = document.querySelector('#licensePolicyModal .btn-primary');
        createButton.disabled = true;
        createButton.innerHTML = '<i class="bi bi-hourglass-split"></i> 생성 중...';
        
        // 순차적으로 정책 생성
        let successCount = 0;
        let errors = [];
        
        for (const licenseName of licensesToCreate) {
            try {
                const formData = {
                    license_name: licenseName,
                    action: action,
                    reason: reason,
                    is_active: isActive
                };
                
                const response = await fetch('/api/v1/policies/licenses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    successCount++;
                } else {
                    const error = await response.text();
                    errors.push(`${licenseName}: ${error}`);
                }
            } catch (error) {
                errors.push(`${licenseName}: ${error.message}`);
            }
        }
        
        // 결과 메시지
        let message = `${successCount}개의 라이선스 정책이 생성되었습니다.`;
        if (errors.length > 0) {
            message += `\n\n실패한 정책:\n${errors.join('\n')}`;
        }
        alert(message);
        
        // 모달 닫기 및 폼 초기화
        bootstrap.Modal.getInstance(document.getElementById('licensePolicyModal')).hide();
        resetLicensePolicyForm();
        
        // 정책 다시 로드
        await loadPolicies();
        
    } catch (error) {
        console.error('Error creating license policies:', error);
        alert('라이선스 정책 생성 중 오류가 발생했습니다.');
    } finally {
        const createButton = document.querySelector('#licensePolicyModal .btn-primary');
        createButton.disabled = false;
        createButton.innerHTML = '<span id="createButtonText">정책 생성</span>';
    }
}

// 폼 초기화
function resetLicensePolicyForm() {
    document.getElementById('licensePolicyForm').reset();
    document.querySelectorAll('.license-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('customLicenseName').value = '';
    document.getElementById('licenseSearch').value = '';
    updateSelectedLicenseCount();
    
    // 첫 번째 탭으로 돌아가기
    const firstTab = document.querySelector('#predefined-tab');
    const firstTabPane = document.querySelector('#predefined');
    const secondTabPane = document.querySelector('#custom');
    
    firstTab.classList.add('active');
    document.querySelector('#custom-tab').classList.remove('active');
    firstTabPane.classList.add('show', 'active');
    secondTabPane.classList.remove('show', 'active');
    
    // 필터 초기화
    filterLicenses();
}

// 취약점 정책 생성
async function createVulnPolicy() {
    const formData = {
        min_severity_level: document.getElementById('minSeverity').value,
        max_cvss_score: parseFloat(document.getElementById('maxCVSS').value),
        action: document.getElementById('vulnAction').value,
        grace_period_days: parseInt(document.getElementById('gracePeriod').value) || 0,
        is_active: document.getElementById('vulnActive').checked
    };
    
    try {
        const response = await fetch('/api/v1/policies/vulnerabilities', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
            throw new Error('Failed to create vulnerability policy');
        }
        
        // 모달 닫기 및 폼 초기화
        bootstrap.Modal.getInstance(document.getElementById('vulnPolicyModal')).hide();
        document.getElementById('vulnPolicyForm').reset();
        
        // 정책 다시 로드
        await loadPolicies();
        
    } catch (error) {
        console.error('Error creating vulnerability policy:', error);
        alert('취약점 정책 생성에 실패했습니다.');
    }
}

// 라이선스 정책 삭제
async function deleteLicensePolicy(id) {
    if (!confirm('이 라이선스 정책을 삭제하시겠습니까?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/policies/licenses/${id}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('Failed to delete license policy');
        }
        
        await loadPolicies();
        
    } catch (error) {
        console.error('Error deleting license policy:', error);
        alert('라이선스 정책 삭제에 실패했습니다.');
    }
}

// 취약점 정책 삭제
async function deleteVulnPolicy(id) {
    if (!confirm('이 취약점 정책을 삭제하시겠습니까?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/policies/vulnerabilities/${id}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('Failed to delete vulnerability policy');
        }
        
        await loadPolicies();
        
    } catch (error) {
        console.error('Error deleting vulnerability policy:', error);
        alert('취약점 정책 삭제에 실패했습니다.');
    }
}
</script>
{{end}} 