{{define "policies"}}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">
        <i class="bi bi-gear text-warning"></i>
        정책 관리
    </h1>
    <div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#licensePolicyModal">
            <i class="bi bi-plus-circle"></i>
            라이선스 정책 추가
        </button>
        <button class="btn btn-success ms-2" data-bs-toggle="modal" data-bs-target="#vulnPolicyModal">
            <i class="bi bi-plus-circle"></i>
            취약점 정책 추가
        </button>
    </div>
</div>

<!-- 정책 통계 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-file-text"></i>
                    라이선스 정책
                </h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="text-primary" id="licensePolicyCount">0</h4>
                        <small class="text-muted">활성 정책</small>
                    </div>
                    <div class="text-end">
                        <div class="badge bg-success" id="licenseBlockCount">0</div>
                        <small class="text-muted d-block">차단 정책</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-shield-exclamation"></i>
                    취약점 정책
                </h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="text-primary" id="vulnPolicyCount">0</h4>
                        <small class="text-muted">활성 정책</small>
                    </div>
                    <div class="text-end">
                        <div class="badge bg-danger" id="vulnFailCount">0</div>
                        <small class="text-muted d-block">실패 정책</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 라이선스 정책 -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-file-text"></i>
            라이선스 정책 목록
        </h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="licensePolicyTable">
                <thead>
                    <tr>
                        <th>라이선스명</th>
                        <th>액션</th>
                        <th>사유</th>
                        <th>상태</th>
                        <th>생성일</th>
                        <th>액션</th>
                    </tr>
                </thead>
                <tbody id="licensePolicyTableBody">
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <i class="bi bi-hourglass-split"></i>
                            로딩 중...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 취약점 정책 -->
<div class="card">
    <div class="card-header">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="bi bi-shield-exclamation"></i>
            취약점 정책 목록
        </h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="vulnPolicyTable">
                <thead>
                    <tr>
                        <th>최소 심각도</th>
                        <th>최대 CVSS</th>
                        <th>액션</th>
                        <th>유예기간</th>
                        <th>상태</th>
                        <th>생성일</th>
                        <th>액션</th>
                    </tr>
                </thead>
                <tbody id="vulnPolicyTableBody">
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="bi bi-hourglass-split"></i>
                            로딩 중...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 라이선스 정책 모달 -->
<div class="modal fade" id="licensePolicyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">라이선스 정책 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="licensePolicyForm">
                    <div class="mb-3">
                        <label for="licenseName" class="form-label">라이선스명</label>
                        <input type="text" class="form-control" id="licenseName" required>
                        <div class="form-text">예: GPL-3.0, MIT, Apache-2.0</div>
                    </div>
                    <div class="mb-3">
                        <label for="licenseAction" class="form-label">액션</label>
                        <select class="form-select" id="licenseAction" required>
                            <option value="block">차단</option>
                            <option value="warn">경고</option>
                            <option value="allow">허용</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="licenseReason" class="form-label">사유</label>
                        <textarea class="form-control" id="licenseReason" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="licenseActive" checked>
                            <label class="form-check-label" for="licenseActive">
                                활성화
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="createLicensePolicy()">생성</button>
            </div>
        </div>
    </div>
</div>

<!-- 취약점 정책 모달 -->
<div class="modal fade" id="vulnPolicyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">취약점 정책 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="vulnPolicyForm">
                    <div class="mb-3">
                        <label for="minSeverity" class="form-label">최소 심각도</label>
                        <select class="form-select" id="minSeverity" required>
                            <option value="Critical">Critical</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="maxCVSS" class="form-label">최대 CVSS 점수</label>
                        <input type="number" class="form-control" id="maxCVSS" min="0" max="10" step="0.1" required>
                        <div class="form-text">0.0 (낮음) ~ 10.0 (높음)</div>
                    </div>
                    <div class="mb-3">
                        <label for="vulnAction" class="form-label">액션</label>
                        <select class="form-select" id="vulnAction" required>
                            <option value="fail">실패</option>
                            <option value="warn">경고</option>
                            <option value="allow">허용</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="gracePeriod" class="form-label">유예기간 (일)</label>
                        <input type="number" class="form-control" id="gracePeriod" min="0" value="0">
                        <div class="form-text">0 = 즉시 적용</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="vulnActive" checked>
                            <label class="form-check-label" for="vulnActive">
                                활성화
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="createVulnPolicy()">생성</button>
            </div>
        </div>
    </div>
</div>

<script>
let licensePolicies = [];
let vulnPolicies = [];

// 페이지 로드 시 정책 데이터 로드
document.addEventListener('DOMContentLoaded', function() {
    loadPolicies();
});

// 정책 데이터 로드
async function loadPolicies() {
    await Promise.all([
        loadLicensePolicies(),
        loadVulnPolicies()
    ]);
    updateStatistics();
}

// 라이선스 정책 로드
async function loadLicensePolicies() {
    try {
        const response = await fetch('/api/v1/policies/licenses');
        if (!response.ok) {
            throw new Error('Failed to fetch license policies');
        }
        
        licensePolicies = await response.json();
        updateLicensePolicyTable();
    } catch (error) {
        console.error('Error loading license policies:', error);
        document.getElementById('licensePolicyTableBody').innerHTML = 
            '<tr><td colspan="6" class="text-center text-danger">데이터 로드 실패</td></tr>';
    }
}

// 취약점 정책 로드
async function loadVulnPolicies() {
    try {
        const response = await fetch('/api/v1/policies/vulnerabilities');
        if (!response.ok) {
            throw new Error('Failed to fetch vulnerability policies');
        }
        
        vulnPolicies = await response.json();
        updateVulnPolicyTable();
    } catch (error) {
        console.error('Error loading vulnerability policies:', error);
        document.getElementById('vulnPolicyTableBody').innerHTML = 
            '<tr><td colspan="7" class="text-center text-danger">데이터 로드 실패</td></tr>';
    }
}

// 통계 업데이트
function updateStatistics() {
    const activeLicensePolicies = licensePolicies.filter(p => p.is_active);
    const blockLicensePolicies = activeLicensePolicies.filter(p => p.action === 'block');
    
    const activeVulnPolicies = vulnPolicies.filter(p => p.is_active);
    const failVulnPolicies = activeVulnPolicies.filter(p => p.action === 'fail');
    
    document.getElementById('licensePolicyCount').textContent = activeLicensePolicies.length;
    document.getElementById('licenseBlockCount').textContent = blockLicensePolicies.length;
    document.getElementById('vulnPolicyCount').textContent = activeVulnPolicies.length;
    document.getElementById('vulnFailCount').textContent = failVulnPolicies.length;
}

// 라이선스 정책 테이블 업데이트
function updateLicensePolicyTable() {
    const tbody = document.getElementById('licensePolicyTableBody');
    
    if (licensePolicies.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">라이선스 정책이 없습니다</td></tr>';
        return;
    }
    
    tbody.innerHTML = licensePolicies.map(policy => `
        <tr>
            <td><strong>${policy.license_name}</strong></td>
            <td>
                <span class="badge bg-${getActionColor(policy.action)}">${policy.action}</span>
            </td>
            <td>${policy.reason || '-'}</td>
            <td>
                <span class="badge bg-${policy.is_active ? 'success' : 'secondary'}">
                    ${policy.is_active ? '활성' : '비활성'}
                </span>
            </td>
            <td>${policy.created_at ? new Date(policy.created_at).toLocaleDateString() : '-'}</td>
            <td>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteLicensePolicy(${policy.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

// 취약점 정책 테이블 업데이트
function updateVulnPolicyTable() {
    const tbody = document.getElementById('vulnPolicyTableBody');
    
    if (vulnPolicies.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">취약점 정책이 없습니다</td></tr>';
        return;
    }
    
    tbody.innerHTML = vulnPolicies.map(policy => `
        <tr>
            <td>
                <span class="badge severity-${policy.min_severity_level.toLowerCase()}">${policy.min_severity_level}</span>
            </td>
            <td>${policy.max_cvss_score || 'N/A'}</td>
            <td>
                <span class="badge bg-${getActionColor(policy.action)}">${policy.action}</span>
            </td>
            <td>${policy.grace_period_days || 0}일</td>
            <td>
                <span class="badge bg-${policy.is_active ? 'success' : 'secondary'}">
                    ${policy.is_active ? '활성' : '비활성'}
                </span>
            </td>
            <td>${policy.created_at ? new Date(policy.created_at).toLocaleDateString() : '-'}</td>
            <td>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteVulnPolicy(${policy.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

// 액션 색상 반환
function getActionColor(action) {
    switch (action) {
        case 'block':
        case 'fail':
            return 'danger';
        case 'warn':
            return 'warning';
        case 'allow':
            return 'success';
        default:
            return 'secondary';
    }
}

// 라이선스 정책 생성
async function createLicensePolicy() {
    const formData = {
        license_name: document.getElementById('licenseName').value,
        action: document.getElementById('licenseAction').value,
        reason: document.getElementById('licenseReason').value,
        is_active: document.getElementById('licenseActive').checked
    };
    
    try {
        const response = await fetch('/api/v1/policies/licenses', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
            throw new Error('Failed to create license policy');
        }
        
        // 모달 닫기 및 폼 초기화
        bootstrap.Modal.getInstance(document.getElementById('licensePolicyModal')).hide();
        document.getElementById('licensePolicyForm').reset();
        
        // 정책 다시 로드
        await loadPolicies();
        
    } catch (error) {
        console.error('Error creating license policy:', error);
        alert('라이선스 정책 생성에 실패했습니다.');
    }
}

// 취약점 정책 생성
async function createVulnPolicy() {
    const formData = {
        min_severity_level: document.getElementById('minSeverity').value,
        max_cvss_score: parseFloat(document.getElementById('maxCVSS').value),
        action: document.getElementById('vulnAction').value,
        grace_period_days: parseInt(document.getElementById('gracePeriod').value) || 0,
        is_active: document.getElementById('vulnActive').checked
    };
    
    try {
        const response = await fetch('/api/v1/policies/vulnerabilities', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
            throw new Error('Failed to create vulnerability policy');
        }
        
        // 모달 닫기 및 폼 초기화
        bootstrap.Modal.getInstance(document.getElementById('vulnPolicyModal')).hide();
        document.getElementById('vulnPolicyForm').reset();
        
        // 정책 다시 로드
        await loadPolicies();
        
    } catch (error) {
        console.error('Error creating vulnerability policy:', error);
        alert('취약점 정책 생성에 실패했습니다.');
    }
}

// 라이선스 정책 삭제
async function deleteLicensePolicy(id) {
    if (!confirm('이 라이선스 정책을 삭제하시겠습니까?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/policies/licenses/${id}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('Failed to delete license policy');
        }
        
        await loadPolicies();
        
    } catch (error) {
        console.error('Error deleting license policy:', error);
        alert('라이선스 정책 삭제에 실패했습니다.');
    }
}

// 취약점 정책 삭제
async function deleteVulnPolicy(id) {
    if (!confirm('이 취약점 정책을 삭제하시겠습니까?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/policies/vulnerabilities/${id}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('Failed to delete vulnerability policy');
        }
        
        await loadPolicies();
        
    } catch (error) {
        console.error('Error deleting vulnerability policy:', error);
        alert('취약점 정책 삭제에 실패했습니다.');
    }
}
</script>
{{end}} 